"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Generate Command
 */
const objectHelper_1 = require("unitejs-framework/dist/helpers/objectHelper");
const parameterValidation_1 = require("unitejs-framework/dist/helpers/parameterValidation");
const engineCommandBase_1 = require("../engine/engineCommandBase");
const templateHelper_1 = require("../helpers/templateHelper");
class GenerateCommand extends engineCommandBase_1.EngineCommandBase {
    run(args) {
        return __awaiter(this, void 0, void 0, function* () {
            const uniteConfiguration = yield this.loadConfiguration(args.outputDirectory, undefined, undefined, false);
            if (!uniteConfiguration) {
                this._logger.error("There is no unite.json to use for configuration.");
                return 1;
            }
            if (!parameterValidation_1.ParameterValidation.notEmpty(this._logger, "name", args.name)) {
                return 1;
            }
            if (!parameterValidation_1.ParameterValidation.notEmpty(this._logger, "type", args.type)) {
                return 1;
            }
            this._logger.info("");
            try {
                const generateTemplatesFolder = this._fileSystem.pathCombine(this._engineAssetsFolder, `appFramework/${uniteConfiguration.applicationFramework.toLowerCase()}/generate/`);
                const exists = yield this._fileSystem.fileExists(generateTemplatesFolder, "generate-templates.json");
                if (exists) {
                    const generateTemplates = yield this._fileSystem.fileReadJson(generateTemplatesFolder, "generate-templates.json");
                    const keys = Object.keys(generateTemplates);
                    const typeLower = args.type.toLowerCase();
                    const templateKey = keys.find(k => k.toLowerCase() === typeLower);
                    if (templateKey) {
                        let template = generateTemplates[templateKey];
                        const sharedGenerateTemplatesFolder = this._fileSystem.pathCombine(this._engineAssetsFolder, `appFramework/shared/generate/`);
                        if (generateTemplates[templateKey].isShared) {
                            const sharedExists = yield this._fileSystem.fileExists(sharedGenerateTemplatesFolder, "generate-templates.json");
                            if (sharedExists) {
                                const sharedGenerateTemplates = yield this._fileSystem.fileReadJson(sharedGenerateTemplatesFolder, "generate-templates.json");
                                if (sharedGenerateTemplates[templateKey]) {
                                    template = objectHelper_1.ObjectHelper.merge(template, sharedGenerateTemplates[templateKey]);
                                }
                                else {
                                    this._logger.error(`Can not find a type of '${args.type}' in the shared templates'`);
                                    return 1;
                                }
                            }
                            else {
                                this._logger.error(`There are no shared generate-templates and shared template '${args.type}' is required`);
                                return 1;
                            }
                        }
                        return yield this.generateFromTemplate(args, uniteConfiguration, generateTemplates[templateKey].isShared ? sharedGenerateTemplatesFolder : generateTemplatesFolder, template);
                    }
                    else {
                        this._logger.error(`Can not find a type of '${args.type}' for applicationFramework '${uniteConfiguration.applicationFramework}, possible values are [${keys.join(", ")}]'`);
                        return 1;
                    }
                }
                else {
                    this._logger.error(`There are no generate-templates for applicationFramework '${uniteConfiguration.applicationFramework}'`);
                    return 1;
                }
            }
            catch (err) {
                this._logger.error(`There was an error loading generate-templates for applicationFramework '${uniteConfiguration.applicationFramework}'`, err);
                return 1;
            }
        });
    }
    generateFromTemplate(args, uniteConfiguration, generateTemplatesFolder, generateTemplate) {
        return __awaiter(this, void 0, void 0, function* () {
            const substitutions = templateHelper_1.TemplateHelper.generateSubstitutions("GEN_NAME", args.name);
            substitutions.ADDITIONAL_EXTENSION = generateTemplate.additionalExtension !== undefined &&
                generateTemplate.additionalExtension !== null &&
                generateTemplate.additionalExtension.length > 0 ? `.${generateTemplate.additionalExtension}` : "";
            // See where we are in relation to the www folder
            const baseDirectory = this._fileSystem.pathAbsolute("./");
            const wwwFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(args.outputDirectory, uniteConfiguration.dirs.wwwRoot));
            const srcFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(wwwFolder, uniteConfiguration.dirs.www.src));
            // If we are somewhere in the srcFolder use that as a starting point, otherwise just use src root
            const startSrcFolder = baseDirectory.startsWith(srcFolder) ? baseDirectory : srcFolder;
            // Calculate any subFolder based on arg or default with substitutions
            const subFolder = args.subFolder !== undefined && args.subFolder !== null ? args.subFolder :
                generateTemplate.defaultFolder !== undefined && generateTemplate.defaultFolder !== null ? templateHelper_1.TemplateHelper.replaceSubstitutions(substitutions, generateTemplate.defaultFolder) : "";
            // Now combine the output folder
            const srcOutputFolder = this._fileSystem.pathCombine(startSrcFolder, subFolder);
            // Find the relativee from srcFolder to srcOutputFolder so we can combine for other folder structures
            const srcRelative = this._fileSystem.pathFileRelative(srcFolder, srcOutputFolder);
            let ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.sourceFiles, srcOutputFolder, `${args.type}/src`, uniteConfiguration.sourceExtensions, substitutions);
            if (ret === 0) {
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.viewFiles, srcOutputFolder, `${args.type}/view`, uniteConfiguration.viewExtensions, substitutions);
            }
            if (ret === 0) {
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.styleFiles, srcOutputFolder, `${args.type}/style`, [uniteConfiguration.styleExtension], substitutions);
            }
            if (ret === 0 && uniteConfiguration.unitTestRunner !== "None") {
                const unitSrcFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(wwwFolder, uniteConfiguration.dirs.www.unitTestSrc));
                const unitSrcOutputFolder = this._fileSystem.pathCombine(unitSrcFolder, srcRelative);
                substitutions.GEN_UNIT_TEST_RELATIVE = this._fileSystem.pathToWeb(this._fileSystem.pathDirectoryRelative(unitSrcOutputFolder, srcOutputFolder));
                if (substitutions.GEN_UNIT_TEST_RELATIVE.startsWith("./")) {
                    substitutions.GEN_UNIT_TEST_RELATIVE = substitutions.GEN_UNIT_TEST_RELATIVE.substring(2);
                }
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.unitTestFiles, unitSrcOutputFolder, `${args.type}/unit/${uniteConfiguration.unitTestFramework.toLowerCase()}`, uniteConfiguration.sourceExtensions, substitutions);
            }
            if (ret === 0 && uniteConfiguration.e2eTestRunner !== "None") {
                const e2eSrcFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(wwwFolder, uniteConfiguration.dirs.www.e2eTestSrc));
                const e2eSrcOutputFolder = this._fileSystem.pathCombine(e2eSrcFolder, srcRelative);
                substitutions.GEN_E2E_TEST_RELATIVE = this._fileSystem.pathToWeb(this._fileSystem.pathDirectoryRelative(e2eSrcOutputFolder, srcOutputFolder));
                if (substitutions.GEN_E2E_TEST_RELATIVE.startsWith("./")) {
                    substitutions.GEN_E2E_TEST_RELATIVE = substitutions.GEN_E2E_TEST_RELATIVE.substring(2);
                }
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.e2eTestFiles, e2eSrcOutputFolder, `${args.type}/e2e/${uniteConfiguration.unitTestFramework.toLowerCase()}`, uniteConfiguration.sourceExtensions, substitutions);
            }
            if (ret === 0) {
                this._logger.banner("Successfully Completed.");
            }
            return ret;
        });
    }
    copyFiles(generateTemplatesFolder, filenames, destFolder, templateSubFolder, possibleExtensions, substitutions) {
        return __awaiter(this, void 0, void 0, function* () {
            if (filenames && filenames.length > 0) {
                const srcFolder = this._fileSystem.pathCombine(generateTemplatesFolder, templateSubFolder);
                for (let i = 0; i < filenames.length; i++) {
                    const srcFilename = filenames[i];
                    let doneCopy = false;
                    for (let j = 0; j < possibleExtensions.length && !doneCopy; j++) {
                        let srcFilename2 = srcFilename.replace("{EXTENSION}", possibleExtensions[j]);
                        srcFilename2 = srcFilename2.replace("{ADDITIONAL_EXTENSION}", "");
                        let destFilename = templateHelper_1.TemplateHelper.replaceSubstitutions(substitutions, srcFilename);
                        destFilename = destFilename.replace("{EXTENSION}", possibleExtensions[j]);
                        try {
                            const exists = yield this._fileSystem.fileExists(srcFolder, srcFilename2);
                            if (exists) {
                                let content = yield this._fileSystem.fileReadText(srcFolder, srcFilename2);
                                if (content.startsWith("!")) {
                                    this._logger.error(content.substr(1));
                                    return 1;
                                }
                                else {
                                    content = templateHelper_1.TemplateHelper.replaceSubstitutions(substitutions, content);
                                    yield this._fileSystem.directoryCreate(destFolder);
                                    yield this._fileSystem.fileWriteText(destFolder, destFilename, content);
                                    doneCopy = true;
                                }
                            }
                        }
                        catch (err) {
                            this._logger.error(`There was an generating from the template`, err, { srcFolder, srcFilename2, destFolder, destFilename });
                            return 1;
                        }
                    }
                    if (!doneCopy) {
                        this._logger.error(`Can not find a source for '${srcFilename}' with the possible extensions [${possibleExtensions.join(", ")}]`);
                        return 1;
                    }
                }
            }
            return 0;
        });
    }
}
exports.GenerateCommand = GenerateCommand;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZUNvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztHQUVHO0FBQ0gsOEVBQTJFO0FBQzNFLDRGQUF5RjtBQUl6RixtRUFBZ0U7QUFDaEUsOERBQTJEO0FBSTNELHFCQUE2QixTQUFRLHFDQUFpQjtJQUNyQyxHQUFHLENBQUMsSUFBNEI7O1lBQ3pDLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRTNHLEVBQUUsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO2dCQUN2RSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2IsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMseUNBQW1CLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pFLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDYixDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyx5Q0FBbUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNiLENBQUM7WUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUV0QixJQUFJLENBQUM7Z0JBQ0QsTUFBTSx1QkFBdUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsZ0JBQWdCLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFFMUssTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyx1QkFBdUIsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO2dCQUVyRyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNULE1BQU0saUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBMEIsdUJBQXVCLEVBQUUseUJBQXlCLENBQUMsQ0FBQztvQkFFM0ksTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO29CQUU1QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUUxQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLEtBQUssU0FBUyxDQUFDLENBQUM7b0JBRWxFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7d0JBQ2QsSUFBSSxRQUFRLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7d0JBQzlDLE1BQU0sNkJBQTZCLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLCtCQUErQixDQUFDLENBQUM7d0JBQzlILEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7NEJBQzFDLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsNkJBQTZCLEVBQUUseUJBQXlCLENBQUMsQ0FBQzs0QkFFakgsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQ0FDZixNQUFNLHVCQUF1QixHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQTBCLDZCQUE2QixFQUFFLHlCQUF5QixDQUFDLENBQUM7Z0NBRXZKLEVBQUUsQ0FBQyxDQUFDLHVCQUF1QixDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQ0FDdkMsUUFBUSxHQUFHLDJCQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSx1QkFBdUIsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dDQUNsRixDQUFDO2dDQUFDLElBQUksQ0FBQyxDQUFDO29DQUNKLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJCQUEyQixJQUFJLENBQUMsSUFBSSw0QkFBNEIsQ0FBQyxDQUFDO29DQUNyRixNQUFNLENBQUMsQ0FBQyxDQUFDO2dDQUNiLENBQUM7NEJBQ0wsQ0FBQzs0QkFBQyxJQUFJLENBQUMsQ0FBQztnQ0FDSixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQywrREFBK0QsSUFBSSxDQUFDLElBQUksZUFBZSxDQUFDLENBQUM7Z0NBQzVHLE1BQU0sQ0FBQyxDQUFDLENBQUM7NEJBQ2IsQ0FBQzt3QkFDTCxDQUFDO3dCQUNELE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxHQUFHLDZCQUE2QixHQUFHLHVCQUF1QixFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUNsTCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJCQUEyQixJQUFJLENBQUMsSUFBSSwrQkFBK0Isa0JBQWtCLENBQUMsb0JBQW9CLDBCQUEwQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDNUssTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDYixDQUFDO2dCQUNMLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkRBQTZELGtCQUFrQixDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQztvQkFDNUgsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDYixDQUFDO1lBQ0wsQ0FBQztZQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ1gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsMkVBQTJFLGtCQUFrQixDQUFDLG9CQUFvQixHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQy9JLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDYixDQUFDO1FBQ0wsQ0FBQztLQUFBO0lBRWEsb0JBQW9CLENBQUMsSUFBNEIsRUFDNUIsa0JBQXNDLEVBQ3RDLHVCQUErQixFQUMvQixnQkFBd0M7O1lBRXZFLE1BQU0sYUFBYSxHQUFHLCtCQUFjLENBQUMscUJBQXFCLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRixhQUFhLENBQUMsb0JBQW9CLEdBQUcsZ0JBQWdCLENBQUMsbUJBQW1CLEtBQUssU0FBUztnQkFDbkYsZ0JBQWdCLENBQUMsbUJBQW1CLEtBQUssSUFBSTtnQkFDN0MsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxJQUFJLGdCQUFnQixDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRSxDQUFDO1lBRXRHLGlEQUFpRDtZQUNqRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3JJLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFMUgsaUdBQWlHO1lBQ2pHLE1BQU0sY0FBYyxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsYUFBYSxHQUFHLFNBQVMsQ0FBQztZQUV2RixxRUFBcUU7WUFDckUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVM7Z0JBQ3RGLGdCQUFnQixDQUFDLGFBQWEsS0FBSyxTQUFTLElBQUksZ0JBQWdCLENBQUMsYUFBYSxLQUFLLElBQUksR0FBRywrQkFBYyxDQUFDLG9CQUFvQixDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUM7WUFFdEwsZ0NBQWdDO1lBQ2hDLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUVoRixxR0FBcUc7WUFDckcsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUM7WUFFbEYsSUFBSSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixFQUN2QixnQkFBZ0IsQ0FBQyxXQUFXLEVBQzVCLGVBQWUsRUFDZixHQUFHLElBQUksQ0FBQyxJQUFJLE1BQU0sRUFDbEIsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQ25DLGFBQWEsQ0FBQyxDQUFDO1lBRTlDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNaLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsdUJBQXVCLEVBQ3ZCLGdCQUFnQixDQUFDLFNBQVMsRUFDMUIsZUFBZSxFQUNmLEdBQUcsSUFBSSxDQUFDLElBQUksT0FBTyxFQUNuQixrQkFBa0IsQ0FBQyxjQUFjLEVBQ2pDLGFBQWEsQ0FBQyxDQUFDO1lBQzlDLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDWixHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixFQUN2QixnQkFBZ0IsQ0FBQyxVQUFVLEVBQzNCLGVBQWUsRUFDZixHQUFHLElBQUksQ0FBQyxJQUFJLFFBQVEsRUFDcEIsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsRUFDbkMsYUFBYSxDQUFDLENBQUM7WUFDOUMsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksa0JBQWtCLENBQUMsY0FBYyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQzVELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RJLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUNyRixhQUFhLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxtQkFBbUIsRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDO2dCQUNoSixFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsc0JBQXNCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEQsYUFBYSxDQUFDLHNCQUFzQixHQUFHLGFBQWEsQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdGLENBQUM7Z0JBRUQsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsRUFDdkIsZ0JBQWdCLENBQUMsYUFBYSxFQUM5QixtQkFBbUIsRUFDbkIsR0FBRyxJQUFJLENBQUMsSUFBSSxTQUFTLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQ3pFLGtCQUFrQixDQUFDLGdCQUFnQixFQUNuQyxhQUFhLENBQUMsQ0FBQztZQUM5QyxDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxhQUFhLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDM0QsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDcEksTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQ25GLGFBQWEsQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUM7Z0JBQzlJLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN2RCxhQUFhLENBQUMscUJBQXFCLEdBQUcsYUFBYSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0YsQ0FBQztnQkFFRCxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixFQUN2QixnQkFBZ0IsQ0FBQyxZQUFZLEVBQzdCLGtCQUFrQixFQUNsQixHQUFHLElBQUksQ0FBQyxJQUFJLFFBQVEsa0JBQWtCLENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLEVBQUUsRUFDeEUsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQ25DLGFBQWEsQ0FBQyxDQUFDO1lBQzlDLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDWixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQ25ELENBQUM7WUFFRCxNQUFNLENBQUMsR0FBRyxDQUFDO1FBQ2YsQ0FBQztLQUFBO0lBRWEsU0FBUyxDQUFDLHVCQUErQixFQUMvQixTQUFtQixFQUNuQixVQUFrQixFQUNsQixpQkFBeUIsRUFDekIsa0JBQTRCLEVBQzVCLGFBQXVDOztZQUMzRCxFQUFFLENBQUMsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO2dCQUUzRixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDeEMsTUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUVqQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7b0JBQ3JCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7d0JBQzlELElBQUksWUFBWSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzdFLFlBQVksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLHdCQUF3QixFQUFFLEVBQUUsQ0FBQyxDQUFDO3dCQUNsRSxJQUFJLFlBQVksR0FBRywrQkFBYyxDQUFDLG9CQUFvQixDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQzt3QkFDbkYsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBRTFFLElBQUksQ0FBQzs0QkFDRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQzs0QkFFMUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQ0FDVCxJQUFJLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztnQ0FFM0UsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0NBQzFCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQ0FDdEMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQ0FDYixDQUFDO2dDQUFDLElBQUksQ0FBQyxDQUFDO29DQUNKLE9BQU8sR0FBRywrQkFBYyxDQUFDLG9CQUFvQixDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztvQ0FFdEUsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztvQ0FFbkQsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO29DQUV4RSxRQUFRLEdBQUcsSUFBSSxDQUFDO2dDQUNwQixDQUFDOzRCQUNMLENBQUM7d0JBQ0wsQ0FBQzt3QkFBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOzRCQUNYLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJDQUEyQyxFQUFFLEdBQUcsRUFBRSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7NEJBQzVILE1BQU0sQ0FBQyxDQUFDLENBQUM7d0JBQ2IsQ0FBQztvQkFDTCxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzt3QkFDWixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsV0FBVyxtQ0FBbUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDakksTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDYixDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNiLENBQUM7S0FBQTtDQUNKO0FBcE5ELDBDQW9OQyIsImZpbGUiOiJjb21tYW5kcy9nZW5lcmF0ZUNvbW1hbmQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEdlbmVyYXRlIENvbW1hbmRcbiAqL1xuaW1wb3J0IHsgT2JqZWN0SGVscGVyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaGVscGVycy9vYmplY3RIZWxwZXJcIjtcbmltcG9ydCB7IFBhcmFtZXRlclZhbGlkYXRpb24gfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9oZWxwZXJzL3BhcmFtZXRlclZhbGlkYXRpb25cIjtcbmltcG9ydCB7IElVbml0ZUdlbmVyYXRlVGVtcGxhdGUgfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvSVVuaXRlR2VuZXJhdGVUZW1wbGF0ZVwiO1xuaW1wb3J0IHsgSVVuaXRlR2VuZXJhdGVUZW1wbGF0ZXMgfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvSVVuaXRlR2VuZXJhdGVUZW1wbGF0ZXNcIjtcbmltcG9ydCB7IFVuaXRlQ29uZmlndXJhdGlvbiB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy91bml0ZS91bml0ZUNvbmZpZ3VyYXRpb25cIjtcbmltcG9ydCB7IEVuZ2luZUNvbW1hbmRCYXNlIH0gZnJvbSBcIi4uL2VuZ2luZS9lbmdpbmVDb21tYW5kQmFzZVwiO1xuaW1wb3J0IHsgVGVtcGxhdGVIZWxwZXIgfSBmcm9tIFwiLi4vaGVscGVycy90ZW1wbGF0ZUhlbHBlclwiO1xuaW1wb3J0IHsgSUVuZ2luZUNvbW1hbmQgfSBmcm9tIFwiLi4vaW50ZXJmYWNlcy9JRW5naW5lQ29tbWFuZFwiO1xuaW1wb3J0IHsgSUdlbmVyYXRlQ29tbWFuZFBhcmFtcyB9IGZyb20gXCIuLi9pbnRlcmZhY2VzL0lHZW5lcmF0ZUNvbW1hbmRQYXJhbXNcIjtcblxuZXhwb3J0IGNsYXNzIEdlbmVyYXRlQ29tbWFuZCBleHRlbmRzIEVuZ2luZUNvbW1hbmRCYXNlIGltcGxlbWVudHMgSUVuZ2luZUNvbW1hbmQ8SUdlbmVyYXRlQ29tbWFuZFBhcmFtcz4ge1xuICAgIHB1YmxpYyBhc3luYyBydW4oYXJnczogSUdlbmVyYXRlQ29tbWFuZFBhcmFtcyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IHVuaXRlQ29uZmlndXJhdGlvbiA9IGF3YWl0IHRoaXMubG9hZENvbmZpZ3VyYXRpb24oYXJncy5vdXRwdXREaXJlY3RvcnksIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmYWxzZSk7XG5cbiAgICAgICAgaWYgKCF1bml0ZUNvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihcIlRoZXJlIGlzIG5vIHVuaXRlLmpzb24gdG8gdXNlIGZvciBjb25maWd1cmF0aW9uLlwiKTtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KHRoaXMuX2xvZ2dlciwgXCJuYW1lXCIsIGFyZ3MubmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KHRoaXMuX2xvZ2dlciwgXCJ0eXBlXCIsIGFyZ3MudHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oXCJcIik7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLl9lbmdpbmVBc3NldHNGb2xkZXIsIGBhcHBGcmFtZXdvcmsvJHt1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmsudG9Mb3dlckNhc2UoKX0vZ2VuZXJhdGUvYCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZUV4aXN0cyhnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlciwgXCJnZW5lcmF0ZS10ZW1wbGF0ZXMuanNvblwiKTtcblxuICAgICAgICAgICAgaWYgKGV4aXN0cykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlVGVtcGxhdGVzID0gYXdhaXQgdGhpcy5fZmlsZVN5c3RlbS5maWxlUmVhZEpzb248SVVuaXRlR2VuZXJhdGVUZW1wbGF0ZXM+KGdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyLCBcImdlbmVyYXRlLXRlbXBsYXRlcy5qc29uXCIpO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGdlbmVyYXRlVGVtcGxhdGVzKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGVMb3dlciA9IGFyZ3MudHlwZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGVLZXkgPSBrZXlzLmZpbmQoayA9PiBrLnRvTG93ZXJDYXNlKCkgPT09IHR5cGVMb3dlcik7XG5cbiAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGVLZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRlbXBsYXRlID0gZ2VuZXJhdGVUZW1wbGF0ZXNbdGVtcGxhdGVLZXldO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGFyZWRHZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlciA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy5fZW5naW5lQXNzZXRzRm9sZGVyLCBgYXBwRnJhbWV3b3JrL3NoYXJlZC9nZW5lcmF0ZS9gKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdlbmVyYXRlVGVtcGxhdGVzW3RlbXBsYXRlS2V5XS5pc1NoYXJlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hhcmVkRXhpc3RzID0gYXdhaXQgdGhpcy5fZmlsZVN5c3RlbS5maWxlRXhpc3RzKHNoYXJlZEdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyLCBcImdlbmVyYXRlLXRlbXBsYXRlcy5qc29uXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhcmVkRXhpc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hhcmVkR2VuZXJhdGVUZW1wbGF0ZXMgPSBhd2FpdCB0aGlzLl9maWxlU3lzdGVtLmZpbGVSZWFkSnNvbjxJVW5pdGVHZW5lcmF0ZVRlbXBsYXRlcz4oc2hhcmVkR2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsIFwiZ2VuZXJhdGUtdGVtcGxhdGVzLmpzb25cIik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhcmVkR2VuZXJhdGVUZW1wbGF0ZXNbdGVtcGxhdGVLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gT2JqZWN0SGVscGVyLm1lcmdlKHRlbXBsYXRlLCBzaGFyZWRHZW5lcmF0ZVRlbXBsYXRlc1t0ZW1wbGF0ZUtleV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgQ2FuIG5vdCBmaW5kIGEgdHlwZSBvZiAnJHthcmdzLnR5cGV9JyBpbiB0aGUgc2hhcmVkIHRlbXBsYXRlcydgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYFRoZXJlIGFyZSBubyBzaGFyZWQgZ2VuZXJhdGUtdGVtcGxhdGVzIGFuZCBzaGFyZWQgdGVtcGxhdGUgJyR7YXJncy50eXBlfScgaXMgcmVxdWlyZWRgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZW5lcmF0ZUZyb21UZW1wbGF0ZShhcmdzLCB1bml0ZUNvbmZpZ3VyYXRpb24sIGdlbmVyYXRlVGVtcGxhdGVzW3RlbXBsYXRlS2V5XS5pc1NoYXJlZCA/IHNoYXJlZEdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyIDogZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsIHRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYENhbiBub3QgZmluZCBhIHR5cGUgb2YgJyR7YXJncy50eXBlfScgZm9yIGFwcGxpY2F0aW9uRnJhbWV3b3JrICcke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29ya30sIHBvc3NpYmxlIHZhbHVlcyBhcmUgWyR7a2V5cy5qb2luKFwiLCBcIil9XSdgKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYFRoZXJlIGFyZSBubyBnZW5lcmF0ZS10ZW1wbGF0ZXMgZm9yIGFwcGxpY2F0aW9uRnJhbWV3b3JrICcke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29ya30nYCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBUaGVyZSB3YXMgYW4gZXJyb3IgbG9hZGluZyBnZW5lcmF0ZS10ZW1wbGF0ZXMgZm9yIGFwcGxpY2F0aW9uRnJhbWV3b3JrICcke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29ya30nYCwgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZUZyb21UZW1wbGF0ZShhcmdzOiBJR2VuZXJhdGVDb21tYW5kUGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uOiBVbml0ZUNvbmZpZ3VyYXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVUZW1wbGF0ZTogSVVuaXRlR2VuZXJhdGVUZW1wbGF0ZSk6IFByb21pc2U8bnVtYmVyPiB7XG5cbiAgICAgICAgY29uc3Qgc3Vic3RpdHV0aW9ucyA9IFRlbXBsYXRlSGVscGVyLmdlbmVyYXRlU3Vic3RpdHV0aW9ucyhcIkdFTl9OQU1FXCIsIGFyZ3MubmFtZSk7XG4gICAgICAgIHN1YnN0aXR1dGlvbnMuQURESVRJT05BTF9FWFRFTlNJT04gPSBnZW5lcmF0ZVRlbXBsYXRlLmFkZGl0aW9uYWxFeHRlbnNpb24gIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgICAgZ2VuZXJhdGVUZW1wbGF0ZS5hZGRpdGlvbmFsRXh0ZW5zaW9uICE9PSBudWxsICYmXG4gICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlLmFkZGl0aW9uYWxFeHRlbnNpb24ubGVuZ3RoID4gMCA/IGAuJHtnZW5lcmF0ZVRlbXBsYXRlLmFkZGl0aW9uYWxFeHRlbnNpb259YCA6IFwiXCI7XG5cbiAgICAgICAgLy8gU2VlIHdoZXJlIHdlIGFyZSBpbiByZWxhdGlvbiB0byB0aGUgd3d3IGZvbGRlclxuICAgICAgICBjb25zdCBiYXNlRGlyZWN0b3J5ID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQWJzb2x1dGUoXCIuL1wiKTtcbiAgICAgICAgY29uc3Qgd3d3Rm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQWJzb2x1dGUodGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZShhcmdzLm91dHB1dERpcmVjdG9yeSwgdW5pdGVDb25maWd1cmF0aW9uLmRpcnMud3d3Um9vdCkpO1xuICAgICAgICBjb25zdCBzcmNGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhBYnNvbHV0ZSh0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKHd3d0ZvbGRlciwgdW5pdGVDb25maWd1cmF0aW9uLmRpcnMud3d3LnNyYykpO1xuXG4gICAgICAgIC8vIElmIHdlIGFyZSBzb21ld2hlcmUgaW4gdGhlIHNyY0ZvbGRlciB1c2UgdGhhdCBhcyBhIHN0YXJ0aW5nIHBvaW50LCBvdGhlcndpc2UganVzdCB1c2Ugc3JjIHJvb3RcbiAgICAgICAgY29uc3Qgc3RhcnRTcmNGb2xkZXIgPSBiYXNlRGlyZWN0b3J5LnN0YXJ0c1dpdGgoc3JjRm9sZGVyKSA/IGJhc2VEaXJlY3RvcnkgOiBzcmNGb2xkZXI7XG5cbiAgICAgICAgLy8gQ2FsY3VsYXRlIGFueSBzdWJGb2xkZXIgYmFzZWQgb24gYXJnIG9yIGRlZmF1bHQgd2l0aCBzdWJzdGl0dXRpb25zXG4gICAgICAgIGNvbnN0IHN1YkZvbGRlciA9IGFyZ3Muc3ViRm9sZGVyICE9PSB1bmRlZmluZWQgJiYgYXJncy5zdWJGb2xkZXIgIT09IG51bGwgPyBhcmdzLnN1YkZvbGRlciA6XG4gICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlLmRlZmF1bHRGb2xkZXIgIT09IHVuZGVmaW5lZCAmJiBnZW5lcmF0ZVRlbXBsYXRlLmRlZmF1bHRGb2xkZXIgIT09IG51bGwgPyBUZW1wbGF0ZUhlbHBlci5yZXBsYWNlU3Vic3RpdHV0aW9ucyhzdWJzdGl0dXRpb25zLCBnZW5lcmF0ZVRlbXBsYXRlLmRlZmF1bHRGb2xkZXIpIDogXCJcIjtcblxuICAgICAgICAvLyBOb3cgY29tYmluZSB0aGUgb3V0cHV0IGZvbGRlclxuICAgICAgICBjb25zdCBzcmNPdXRwdXRGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKHN0YXJ0U3JjRm9sZGVyLCBzdWJGb2xkZXIpO1xuXG4gICAgICAgIC8vIEZpbmQgdGhlIHJlbGF0aXZlZSBmcm9tIHNyY0ZvbGRlciB0byBzcmNPdXRwdXRGb2xkZXIgc28gd2UgY2FuIGNvbWJpbmUgZm9yIG90aGVyIGZvbGRlciBzdHJ1Y3R1cmVzXG4gICAgICAgIGNvbnN0IHNyY1JlbGF0aXZlID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoRmlsZVJlbGF0aXZlKHNyY0ZvbGRlciwgc3JjT3V0cHV0Rm9sZGVyKTtcblxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZXMoZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlLnNvdXJjZUZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjT3V0cHV0Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7YXJncy50eXBlfS9zcmNgLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUV4dGVuc2lvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzdGl0dXRpb25zKTtcblxuICAgICAgICBpZiAocmV0ID09PSAwKSB7XG4gICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlcyhnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVGVtcGxhdGUudmlld0ZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjT3V0cHV0Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7YXJncy50eXBlfS92aWV3YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRlQ29uZmlndXJhdGlvbi52aWV3RXh0ZW5zaW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnN0aXR1dGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJldCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZXMoZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlLnN0eWxlRmlsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmNPdXRwdXRGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHthcmdzLnR5cGV9L3N0eWxlYCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFt1bml0ZUNvbmZpZ3VyYXRpb24uc3R5bGVFeHRlbnNpb25dLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic3RpdHV0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmV0ID09PSAwICYmIHVuaXRlQ29uZmlndXJhdGlvbi51bml0VGVzdFJ1bm5lciAhPT0gXCJOb25lXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHVuaXRTcmNGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhBYnNvbHV0ZSh0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKHd3d0ZvbGRlciwgdW5pdGVDb25maWd1cmF0aW9uLmRpcnMud3d3LnVuaXRUZXN0U3JjKSk7XG4gICAgICAgICAgICBjb25zdCB1bml0U3JjT3V0cHV0Rm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh1bml0U3JjRm9sZGVyLCBzcmNSZWxhdGl2ZSk7XG4gICAgICAgICAgICBzdWJzdGl0dXRpb25zLkdFTl9VTklUX1RFU1RfUkVMQVRJVkUgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhUb1dlYih0aGlzLl9maWxlU3lzdGVtLnBhdGhEaXJlY3RvcnlSZWxhdGl2ZSh1bml0U3JjT3V0cHV0Rm9sZGVyLCBzcmNPdXRwdXRGb2xkZXIpKTtcbiAgICAgICAgICAgIGlmIChzdWJzdGl0dXRpb25zLkdFTl9VTklUX1RFU1RfUkVMQVRJVkUuc3RhcnRzV2l0aChcIi4vXCIpKSB7XG4gICAgICAgICAgICAgICAgc3Vic3RpdHV0aW9ucy5HRU5fVU5JVF9URVNUX1JFTEFUSVZFID0gc3Vic3RpdHV0aW9ucy5HRU5fVU5JVF9URVNUX1JFTEFUSVZFLnN1YnN0cmluZygyKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZXMoZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlLnVuaXRUZXN0RmlsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0U3JjT3V0cHV0Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7YXJncy50eXBlfS91bml0LyR7dW5pdGVDb25maWd1cmF0aW9uLnVuaXRUZXN0RnJhbWV3b3JrLnRvTG93ZXJDYXNlKCl9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRlQ29uZmlndXJhdGlvbi5zb3VyY2VFeHRlbnNpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic3RpdHV0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmV0ID09PSAwICYmIHVuaXRlQ29uZmlndXJhdGlvbi5lMmVUZXN0UnVubmVyICE9PSBcIk5vbmVcIikge1xuICAgICAgICAgICAgY29uc3QgZTJlU3JjRm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQWJzb2x1dGUodGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh3d3dGb2xkZXIsIHVuaXRlQ29uZmlndXJhdGlvbi5kaXJzLnd3dy5lMmVUZXN0U3JjKSk7XG4gICAgICAgICAgICBjb25zdCBlMmVTcmNPdXRwdXRGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKGUyZVNyY0ZvbGRlciwgc3JjUmVsYXRpdmUpO1xuICAgICAgICAgICAgc3Vic3RpdHV0aW9ucy5HRU5fRTJFX1RFU1RfUkVMQVRJVkUgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhUb1dlYih0aGlzLl9maWxlU3lzdGVtLnBhdGhEaXJlY3RvcnlSZWxhdGl2ZShlMmVTcmNPdXRwdXRGb2xkZXIsIHNyY091dHB1dEZvbGRlcikpO1xuICAgICAgICAgICAgaWYgKHN1YnN0aXR1dGlvbnMuR0VOX0UyRV9URVNUX1JFTEFUSVZFLnN0YXJ0c1dpdGgoXCIuL1wiKSkge1xuICAgICAgICAgICAgICAgIHN1YnN0aXR1dGlvbnMuR0VOX0UyRV9URVNUX1JFTEFUSVZFID0gc3Vic3RpdHV0aW9ucy5HRU5fRTJFX1RFU1RfUkVMQVRJVkUuc3Vic3RyaW5nKDIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlcyhnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVGVtcGxhdGUuZTJlVGVzdEZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZTJlU3JjT3V0cHV0Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7YXJncy50eXBlfS9lMmUvJHt1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUV4dGVuc2lvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzdGl0dXRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5iYW5uZXIoXCJTdWNjZXNzZnVsbHkgQ29tcGxldGVkLlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBjb3B5RmlsZXMoZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXI6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlbmFtZXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RGb2xkZXI6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVN1YkZvbGRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3NpYmxlRXh0ZW5zaW9uczogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic3RpdHV0aW9uczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgaWYgKGZpbGVuYW1lcyAmJiBmaWxlbmFtZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3Qgc3JjRm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZShnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlciwgdGVtcGxhdGVTdWJGb2xkZXIpO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbGVuYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNyY0ZpbGVuYW1lID0gZmlsZW5hbWVzW2ldO1xuXG4gICAgICAgICAgICAgICAgbGV0IGRvbmVDb3B5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwb3NzaWJsZUV4dGVuc2lvbnMubGVuZ3RoICYmICFkb25lQ29weTsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzcmNGaWxlbmFtZTIgPSBzcmNGaWxlbmFtZS5yZXBsYWNlKFwie0VYVEVOU0lPTn1cIiwgcG9zc2libGVFeHRlbnNpb25zW2pdKTtcbiAgICAgICAgICAgICAgICAgICAgc3JjRmlsZW5hbWUyID0gc3JjRmlsZW5hbWUyLnJlcGxhY2UoXCJ7QURESVRJT05BTF9FWFRFTlNJT059XCIsIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZGVzdEZpbGVuYW1lID0gVGVtcGxhdGVIZWxwZXIucmVwbGFjZVN1YnN0aXR1dGlvbnMoc3Vic3RpdHV0aW9ucywgc3JjRmlsZW5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBkZXN0RmlsZW5hbWUgPSBkZXN0RmlsZW5hbWUucmVwbGFjZShcIntFWFRFTlNJT059XCIsIHBvc3NpYmxlRXh0ZW5zaW9uc1tqXSk7XG5cbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZUV4aXN0cyhzcmNGb2xkZXIsIHNyY0ZpbGVuYW1lMik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGlzdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgY29udGVudCA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZVJlYWRUZXh0KHNyY0ZvbGRlciwgc3JjRmlsZW5hbWUyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZW50LnN0YXJ0c1dpdGgoXCIhXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihjb250ZW50LnN1YnN0cigxKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBUZW1wbGF0ZUhlbHBlci5yZXBsYWNlU3Vic3RpdHV0aW9ucyhzdWJzdGl0dXRpb25zLCBjb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9maWxlU3lzdGVtLmRpcmVjdG9yeUNyZWF0ZShkZXN0Rm9sZGVyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9maWxlU3lzdGVtLmZpbGVXcml0ZVRleHQoZGVzdEZvbGRlciwgZGVzdEZpbGVuYW1lLCBjb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lQ29weSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgVGhlcmUgd2FzIGFuIGdlbmVyYXRpbmcgZnJvbSB0aGUgdGVtcGxhdGVgLCBlcnIsIHsgc3JjRm9sZGVyLCBzcmNGaWxlbmFtZTIsIGRlc3RGb2xkZXIsIGRlc3RGaWxlbmFtZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZG9uZUNvcHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBDYW4gbm90IGZpbmQgYSBzb3VyY2UgZm9yICcke3NyY0ZpbGVuYW1lfScgd2l0aCB0aGUgcG9zc2libGUgZXh0ZW5zaW9ucyBbJHtwb3NzaWJsZUV4dGVuc2lvbnMuam9pbihcIiwgXCIpfV1gKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxufVxuIl19
