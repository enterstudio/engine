"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const uniteClientPackage_1 = require("../configuration/models/unite/uniteClientPackage");
class EngineVariables {
    constructor() {
        this._configuration = {};
        this.syntheticImport = "";
        this.moduleId = "";
        this.buildTranspileInclude = [];
        this.buildTranspilePreBuild = [];
        this.buildTranspilePostBuild = [];
        this._requiredDevDependencies = [];
        this._removedDevDependencies = [];
        this._requiredClientPackages = {};
        this._removedClientPackages = {};
    }
    setConfiguration(name, config) {
        this._configuration[name] = config;
    }
    getConfiguration(name) {
        return this._configuration[name];
    }
    setupDirectories(fileSystem, rootFolder) {
        this.rootFolder = rootFolder;
        this.wwwRootFolder = fileSystem.pathCombine(this.rootFolder, "www");
        this.packagedRootFolder = fileSystem.pathCombine(this.rootFolder, "packaged");
        this.www = {
            srcFolder: fileSystem.pathCombine(this.wwwRootFolder, "src"),
            distFolder: fileSystem.pathCombine(this.wwwRootFolder, "dist"),
            cssSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "cssSrc"),
            cssDistFolder: fileSystem.pathCombine(this.wwwRootFolder, "css"),
            e2eTestFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e"),
            e2eTestSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e/src"),
            e2eTestDistFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e/dist"),
            unitTestFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/unit"),
            unitTestSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/unit/src"),
            unitTestDistFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/unit/dist"),
            reportsFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/reports"),
            assetsFolder: fileSystem.pathCombine(this.wwwRootFolder, "assets"),
            assetsSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "assetsSrc"),
            buildFolder: fileSystem.pathCombine(this.wwwRootFolder, "build"),
            packageFolder: fileSystem.pathCombine(this.wwwRootFolder, "node_modules")
        };
    }
    initialisePackages(clientPackages) {
        this._requiredClientPackages = clientPackages || {};
    }
    toggleClientPackage(name, main, mainMinified, testingAdditions, preload, includeMode, scriptIncludeMode, isPackage, assets, map, loaders, isModuleLoader, required) {
        if (required) {
            this.addClientPackage(name, main, mainMinified, testingAdditions, preload, includeMode, scriptIncludeMode, isPackage, assets, map, loaders, isModuleLoader);
        }
        else {
            this.removeClientPackage(name);
        }
    }
    addClientPackage(name, main, mainMinified, testingAdditions, preload, includeMode, scriptIncludeMode, isPackage, assets, map, loaders, isModuleLoader) {
        const clientPackage = new uniteClientPackage_1.UniteClientPackage();
        clientPackage.name = name;
        clientPackage.includeMode = includeMode;
        clientPackage.preload = preload;
        clientPackage.main = main;
        clientPackage.mainMinified = mainMinified;
        clientPackage.testingAdditions = testingAdditions;
        clientPackage.isPackage = isPackage;
        clientPackage.version = this.findDependencyVersion(name);
        clientPackage.assets = assets;
        clientPackage.map = map;
        clientPackage.loaders = loaders;
        clientPackage.scriptIncludeMode = scriptIncludeMode;
        clientPackage.isModuleLoader = isModuleLoader;
        this._requiredClientPackages[name] = clientPackage;
    }
    removeClientPackage(name) {
        this._removedClientPackages[name] = undefined;
    }
    toggleDevDependency(dependencies, required) {
        if (required) {
            this.addDevDependency(dependencies);
        }
        else {
            this.removeDevDependency(dependencies);
        }
    }
    addDevDependency(dependencies) {
        dependencies.forEach(dep => {
            if (this._requiredDevDependencies.indexOf(dep) < 0) {
                this._requiredDevDependencies.push(dep);
            }
        });
    }
    removeDevDependency(dependencies) {
        dependencies.forEach(dep => {
            if (this._removedDevDependencies.indexOf(dep) < 0) {
                this._removedDevDependencies.push(dep);
            }
        });
    }
    buildDependencies(uniteConfiguration, packageJsonDependencies) {
        for (const key in this._removedClientPackages) {
            if (packageJsonDependencies[key]) {
                delete packageJsonDependencies[key];
            }
        }
        const addedTestDependencies = [];
        const removedTestDependencies = [];
        for (const pkg in this._requiredClientPackages) {
            uniteConfiguration.clientPackages[pkg] = this._requiredClientPackages[pkg];
            if (this._requiredClientPackages[pkg].includeMode === "app" || this._requiredClientPackages[pkg].includeMode === "both") {
                packageJsonDependencies[pkg] = this._requiredClientPackages[pkg].version;
                const idx = this._requiredDevDependencies.indexOf(pkg);
                if (idx >= 0) {
                    this._requiredDevDependencies.splice(idx, 1);
                    removedTestDependencies.push(pkg);
                }
            }
            else {
                addedTestDependencies.push(pkg);
            }
        }
        this.toggleDevDependency(addedTestDependencies, true);
        this.toggleDevDependency(removedTestDependencies, false);
    }
    buildDevDependencies(packageJsonDevDependencies) {
        this._removedDevDependencies.forEach(dependency => {
            if (packageJsonDevDependencies[dependency]) {
                delete packageJsonDevDependencies[dependency];
            }
        });
        this._requiredDevDependencies.forEach(requiredDependency => {
            packageJsonDevDependencies[requiredDependency] = this.findDependencyVersion(requiredDependency);
        });
    }
    findDependencyVersion(requiredDependency) {
        if (this.enginePackageJson && this.enginePackageJson.peerDependencies) {
            if (this.enginePackageJson.peerDependencies[requiredDependency]) {
                return this.enginePackageJson.peerDependencies[requiredDependency];
            }
            else {
                throw new Error(`Missing Dependency '${requiredDependency}'`);
            }
        }
        else {
            throw new Error("Dependency Versions missing");
        }
    }
}
exports.EngineVariables = EngineVariables;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbmdpbmUvZW5naW5lVmFyaWFibGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBUUEseUZBQXNGO0FBSXRGO0lBK0NJO1FBQ0ksSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFFbkIsSUFBSSxDQUFDLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFFbEMsSUFBSSxDQUFDLHdCQUF3QixHQUFHLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRU0sZ0JBQWdCLENBQUMsSUFBWSxFQUFFLE1BQVc7UUFDN0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUM7SUFDdkMsQ0FBQztJQUVNLGdCQUFnQixDQUFJLElBQVk7UUFDbkMsTUFBTSxDQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVNLGdCQUFnQixDQUFDLFVBQXVCLEVBQUUsVUFBa0I7UUFDL0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENB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LGtCQUFrQixDQUFDLEVBQUU7WUFDdkQsMEJBQTBCLENBQUMsa0JBQWtCLENBQUMsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNwRyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxxQkFBcUIsQ0FBQyxrQkFBMEI7UUFDbkQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7WUFDcEUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5RCxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDdkUsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLGtCQUFrQixHQUFHLENBQUMsQ0FBQztZQUNsRSxDQUFDO1FBQ0wsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1FBQ25ELENBQUM7SUFDTCxDQUFDO0NBQ0o7QUE3T0QsMENBNk9DIiwiZmlsZSI6ImVuZ2luZS9lbmdpbmVWYXJpYWJsZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFZhcmlhYmxlcyB1c2VkIGJ5IHRoZSBlbmdpbmUuXG4gKi9cbmltcG9ydCB7IElGaWxlU3lzdGVtIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JRmlsZVN5c3RlbVwiO1xuaW1wb3J0IHsgUGFja2FnZUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvcGFja2FnZXMvcGFja2FnZUNvbmZpZ3VyYXRpb25cIjtcbmltcG9ydCB7IElTcGR4TGljZW5zZSB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy9zcGR4L0lTcGR4TGljZW5zZVwiO1xuaW1wb3J0IHsgSW5jbHVkZU1vZGUgfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvaW5jbHVkZU1vZGVcIjtcbmltcG9ydCB7IFNjcmlwdEluY2x1ZGVNb2RlIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3VuaXRlL3NjcmlwdEluY2x1ZGVNb2RlXCI7XG5pbXBvcnQgeyBVbml0ZUNsaWVudFBhY2thZ2UgfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvdW5pdGVDbGllbnRQYWNrYWdlXCI7XG5pbXBvcnQgeyBVbml0ZUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvdW5pdGVDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBJUGFja2FnZU1hbmFnZXIgfSBmcm9tIFwiLi4vaW50ZXJmYWNlcy9JUGFja2FnZU1hbmFnZXJcIjtcblxuZXhwb3J0IGNsYXNzIEVuZ2luZVZhcmlhYmxlcyB7XG4gICAgcHVibGljIGZvcmNlOiBib29sZWFuO1xuICAgIHB1YmxpYyBlbmdpbmVSb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHVibGljIGVuZ2luZUFzc2V0c0ZvbGRlcjogc3RyaW5nO1xuICAgIHB1YmxpYyBlbmdpbmVQYWNrYWdlSnNvbjogUGFja2FnZUNvbmZpZ3VyYXRpb247XG5cbiAgICBwdWJsaWMgcm9vdEZvbGRlcjogc3RyaW5nO1xuICAgIHB1YmxpYyB3d3dSb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHVibGljIHBhY2thZ2VkUm9vdEZvbGRlcjogc3RyaW5nO1xuXG4gICAgcHVibGljIHd3dzoge1xuICAgICAgICBzcmNGb2xkZXI6IHN0cmluZztcbiAgICAgICAgZGlzdEZvbGRlcjogc3RyaW5nO1xuICAgICAgICB1bml0VGVzdEZvbGRlcjogc3RyaW5nO1xuICAgICAgICB1bml0VGVzdFNyY0ZvbGRlcjogc3RyaW5nO1xuICAgICAgICB1bml0VGVzdERpc3RGb2xkZXI6IHN0cmluZztcbiAgICAgICAgY3NzU3JjRm9sZGVyOiBzdHJpbmc7XG4gICAgICAgIGNzc0Rpc3RGb2xkZXI6IHN0cmluZztcbiAgICAgICAgZTJlVGVzdEZvbGRlcjogc3RyaW5nO1xuICAgICAgICBlMmVUZXN0U3JjRm9sZGVyOiBzdHJpbmc7XG4gICAgICAgIGUyZVRlc3REaXN0Rm9sZGVyOiBzdHJpbmc7XG4gICAgICAgIHJlcG9ydHNGb2xkZXI6IHN0cmluZztcbiAgICAgICAgcGFja2FnZUZvbGRlcjogc3RyaW5nO1xuICAgICAgICBidWlsZEZvbGRlcjogc3RyaW5nO1xuXG4gICAgICAgIGFzc2V0c0ZvbGRlcjogc3RyaW5nO1xuICAgICAgICBhc3NldHNTcmNGb2xkZXI6IHN0cmluZztcbiAgICB9O1xuXG4gICAgcHVibGljIGxpY2Vuc2U6IElTcGR4TGljZW5zZTtcblxuICAgIHB1YmxpYyBidWlsZFRyYW5zcGlsZUluY2x1ZGU6IHN0cmluZ1tdO1xuICAgIHB1YmxpYyBidWlsZFRyYW5zcGlsZVByZUJ1aWxkOiBzdHJpbmdbXTtcbiAgICBwdWJsaWMgYnVpbGRUcmFuc3BpbGVQb3N0QnVpbGQ6IHN0cmluZ1tdO1xuXG4gICAgcHVibGljIHN5bnRoZXRpY0ltcG9ydDogc3RyaW5nO1xuICAgIHB1YmxpYyBtb2R1bGVJZDogc3RyaW5nO1xuXG4gICAgcHVibGljIHBhY2thZ2VNYW5hZ2VyOiBJUGFja2FnZU1hbmFnZXI7XG5cbiAgICBwcml2YXRlIF9jb25maWd1cmF0aW9uOiB7IFtpZDogc3RyaW5nXTogYW55IH07XG5cbiAgICBwcml2YXRlIF9yZXF1aXJlZERldkRlcGVuZGVuY2llczogc3RyaW5nW107XG4gICAgcHJpdmF0ZSBfcmVtb3ZlZERldkRlcGVuZGVuY2llczogc3RyaW5nW107XG4gICAgcHJpdmF0ZSBfcmVxdWlyZWRDbGllbnRQYWNrYWdlczogeyBbaWQ6IHN0cmluZ106IFVuaXRlQ2xpZW50UGFja2FnZSB9O1xuICAgIHByaXZhdGUgX3JlbW92ZWRDbGllbnRQYWNrYWdlczogeyBbaWQ6IHN0cmluZ106IFVuaXRlQ2xpZW50UGFja2FnZSB9O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuX2NvbmZpZ3VyYXRpb24gPSB7fTtcblxuICAgICAgICB0aGlzLnN5bnRoZXRpY0ltcG9ydCA9IFwiXCI7XG4gICAgICAgIHRoaXMubW9kdWxlSWQgPSBcIlwiO1xuXG4gICAgICAgIHRoaXMuYnVpbGRUcmFuc3BpbGVJbmNsdWRlID0gW107XG4gICAgICAgIHRoaXMuYnVpbGRUcmFuc3BpbGVQcmVCdWlsZCA9IFtdO1xuICAgICAgICB0aGlzLmJ1aWxkVHJhbnNwaWxlUG9zdEJ1aWxkID0gW107XG5cbiAgICAgICAgdGhpcy5fcmVxdWlyZWREZXZEZXBlbmRlbmNpZXMgPSBbXTtcbiAgICAgICAgdGhpcy5fcmVtb3ZlZERldkRlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzID0ge307XG4gICAgICAgIHRoaXMuX3JlbW92ZWRDbGllbnRQYWNrYWdlcyA9IHt9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDb25maWd1cmF0aW9uKG5hbWU6IHN0cmluZywgY29uZmlnOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbltuYW1lXSA9IGNvbmZpZztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q29uZmlndXJhdGlvbjxUPihuYW1lOiBzdHJpbmcpOiBUIHtcbiAgICAgICAgcmV0dXJuIDxUPnRoaXMuX2NvbmZpZ3VyYXRpb25bbmFtZV07XG4gICAgfVxuXG4gICAgcHVibGljIHNldHVwRGlyZWN0b3JpZXMoZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sIHJvb3RGb2xkZXI6IHN0cmluZykgOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yb290Rm9sZGVyID0gcm9vdEZvbGRlcjtcbiAgICAgICAgdGhpcy53d3dSb290Rm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnJvb3RGb2xkZXIsIFwid3d3XCIpO1xuICAgICAgICB0aGlzLnBhY2thZ2VkUm9vdEZvbGRlciA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy5yb290Rm9sZGVyLCBcInBhY2thZ2VkXCIpO1xuICAgICAgICB0aGlzLnd3dyA9IHtcbiAgICAgICAgICAgIHNyY0ZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwic3JjXCIpLFxuICAgICAgICAgICAgZGlzdEZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwiZGlzdFwiKSxcbiAgICAgICAgICAgIGNzc1NyY0ZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwiY3NzU3JjXCIpLFxuICAgICAgICAgICAgY3NzRGlzdEZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwiY3NzXCIpLFxuICAgICAgICAgICAgZTJlVGVzdEZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC9lMmVcIiksXG4gICAgICAgICAgICBlMmVUZXN0U3JjRm9sZGVyOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJ0ZXN0L2UyZS9zcmNcIiksXG4gICAgICAgICAgICBlMmVUZXN0RGlzdEZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC9lMmUvZGlzdFwiKSxcbiAgICAgICAgICAgIHVuaXRUZXN0Rm9sZGVyOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJ0ZXN0L3VuaXRcIiksXG4gICAgICAgICAgICB1bml0VGVzdFNyY0ZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC91bml0L3NyY1wiKSxcbiAgICAgICAgICAgIHVuaXRUZXN0RGlzdEZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC91bml0L2Rpc3RcIiksXG4gICAgICAgICAgICByZXBvcnRzRm9sZGVyOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJ0ZXN0L3JlcG9ydHNcIiksXG4gICAgICAgICAgICBhc3NldHNGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImFzc2V0c1wiKSxcbiAgICAgICAgICAgIGFzc2V0c1NyY0ZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwiYXNzZXRzU3JjXCIpLFxuICAgICAgICAgICAgYnVpbGRGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImJ1aWxkXCIpLFxuICAgICAgICAgICAgcGFja2FnZUZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwibm9kZV9tb2R1bGVzXCIpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIGluaXRpYWxpc2VQYWNrYWdlcyhjbGllbnRQYWNrYWdlczogeyBbaWQ6IHN0cmluZ106IFVuaXRlQ2xpZW50UGFja2FnZSB9KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3JlcXVpcmVkQ2xpZW50UGFja2FnZXMgPSBjbGllbnRQYWNrYWdlcyB8fCB7fTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9nZ2xlQ2xpZW50UGFja2FnZShuYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5NaW5pZmllZDogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RpbmdBZGRpdGlvbnM6ICB7IFtpZDogc3RyaW5nXTogc3RyaW5nfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkOiBib29sZWFuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGVNb2RlOiBJbmNsdWRlTW9kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRJbmNsdWRlTW9kZTogU2NyaXB0SW5jbHVkZU1vZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNQYWNrYWdlOiBib29sZWFuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0czogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcDogeyBbaWQ6IHN0cmluZ106IHN0cmluZ30sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyczogeyBbaWQ6IHN0cmluZ106IHN0cmluZ30sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNNb2R1bGVMb2FkZXI6IGJvb2xlYW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IGJvb2xlYW4pOiB2b2lkIHtcblxuICAgICAgICBpZiAocmVxdWlyZWQpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkQ2xpZW50UGFja2FnZShuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbk1pbmlmaWVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RpbmdBZGRpdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlbG9hZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdWRlTW9kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRJbmNsdWRlTW9kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BhY2thZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzTW9kdWxlTG9hZGVyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2xpZW50UGFja2FnZShuYW1lKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhZGRDbGllbnRQYWNrYWdlKG5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbk1pbmlmaWVkOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGluZ0FkZGl0aW9uczogIHsgW2lkOiBzdHJpbmddOiBzdHJpbmd9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWxvYWQ6IGJvb2xlYW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZU1vZGU6IEluY2x1ZGVNb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEluY2x1ZGVNb2RlOiBTY3JpcHRJbmNsdWRlTW9kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1BhY2thZ2U6IGJvb2xlYW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXRzOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJzOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc01vZHVsZUxvYWRlcjogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBjb25zdCBjbGllbnRQYWNrYWdlID0gbmV3IFVuaXRlQ2xpZW50UGFja2FnZSgpO1xuICAgICAgICBjbGllbnRQYWNrYWdlLm5hbWUgPSBuYW1lO1xuICAgICAgICBjbGllbnRQYWNrYWdlLmluY2x1ZGVNb2RlID0gaW5jbHVkZU1vZGU7XG4gICAgICAgIGNsaWVudFBhY2thZ2UucHJlbG9hZCA9IHByZWxvYWQ7XG4gICAgICAgIGNsaWVudFBhY2thZ2UubWFpbiA9IG1haW47XG4gICAgICAgIGNsaWVudFBhY2thZ2UubWFpbk1pbmlmaWVkID0gbWFpbk1pbmlmaWVkO1xuICAgICAgICBjbGllbnRQYWNrYWdlLnRlc3RpbmdBZGRpdGlvbnMgPSB0ZXN0aW5nQWRkaXRpb25zO1xuICAgICAgICBjbGllbnRQYWNrYWdlLmlzUGFja2FnZSA9IGlzUGFja2FnZTtcbiAgICAgICAgY2xpZW50UGFja2FnZS52ZXJzaW9uID0gdGhpcy5maW5kRGVwZW5kZW5jeVZlcnNpb24obmFtZSk7XG4gICAgICAgIGNsaWVudFBhY2thZ2UuYXNzZXRzID0gYXNzZXRzO1xuICAgICAgICBjbGllbnRQYWNrYWdlLm1hcCA9IG1hcDtcbiAgICAgICAgY2xpZW50UGFja2FnZS5sb2FkZXJzID0gbG9hZGVycztcbiAgICAgICAgY2xpZW50UGFja2FnZS5zY3JpcHRJbmNsdWRlTW9kZSA9IHNjcmlwdEluY2x1ZGVNb2RlO1xuICAgICAgICBjbGllbnRQYWNrYWdlLmlzTW9kdWxlTG9hZGVyID0gaXNNb2R1bGVMb2FkZXI7XG4gICAgICAgIHRoaXMuX3JlcXVpcmVkQ2xpZW50UGFja2FnZXNbbmFtZV0gPSBjbGllbnRQYWNrYWdlO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVDbGllbnRQYWNrYWdlKG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLl9yZW1vdmVkQ2xpZW50UGFja2FnZXNbbmFtZV0gPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZURldkRlcGVuZGVuY3koZGVwZW5kZW5jaWVzOiBzdHJpbmdbXSwgcmVxdWlyZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgaWYgKHJlcXVpcmVkKSB7XG4gICAgICAgICAgICB0aGlzLmFkZERldkRlcGVuZGVuY3koZGVwZW5kZW5jaWVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRGV2RGVwZW5kZW5jeShkZXBlbmRlbmNpZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFkZERldkRlcGVuZGVuY3koZGVwZW5kZW5jaWVzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgICAgICBkZXBlbmRlbmNpZXMuZm9yRWFjaChkZXAgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzLmluZGV4T2YoZGVwKSA8IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9yZXF1aXJlZERldkRlcGVuZGVuY2llcy5wdXNoKGRlcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVEZXZEZXBlbmRlbmN5KGRlcGVuZGVuY2llczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgZGVwZW5kZW5jaWVzLmZvckVhY2goZGVwID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9yZW1vdmVkRGV2RGVwZW5kZW5jaWVzLmluZGV4T2YoZGVwKSA8IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVkRGV2RGVwZW5kZW5jaWVzLnB1c2goZGVwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGJ1aWxkRGVwZW5kZW5jaWVzKHVuaXRlQ29uZmlndXJhdGlvbjogVW5pdGVDb25maWd1cmF0aW9uLCBwYWNrYWdlSnNvbkRlcGVuZGVuY2llczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9KTogdm9pZCB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3JlbW92ZWRDbGllbnRQYWNrYWdlcykge1xuICAgICAgICAgICAgaWYgKHBhY2thZ2VKc29uRGVwZW5kZW5jaWVzW2tleV0pIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgcGFja2FnZUpzb25EZXBlbmRlbmNpZXNba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGFkZGVkVGVzdERlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICBjb25zdCByZW1vdmVkVGVzdERlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHBrZyBpbiB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzKSB7XG4gICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb24uY2xpZW50UGFja2FnZXNbcGtnXSA9IHRoaXMuX3JlcXVpcmVkQ2xpZW50UGFja2FnZXNbcGtnXTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW3BrZ10uaW5jbHVkZU1vZGUgPT09IFwiYXBwXCIgfHwgdGhpcy5fcmVxdWlyZWRDbGllbnRQYWNrYWdlc1twa2ddLmluY2x1ZGVNb2RlID09PSBcImJvdGhcIikge1xuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uRGVwZW5kZW5jaWVzW3BrZ10gPSB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW3BrZ10udmVyc2lvbjtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzLmluZGV4T2YocGtnKTtcbiAgICAgICAgICAgICAgICBpZiAoaWR4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVxdWlyZWREZXZEZXBlbmRlbmNpZXMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZWRUZXN0RGVwZW5kZW5jaWVzLnB1c2gocGtnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkZGVkVGVzdERlcGVuZGVuY2llcy5wdXNoKHBrZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50b2dnbGVEZXZEZXBlbmRlbmN5KGFkZGVkVGVzdERlcGVuZGVuY2llcywgdHJ1ZSk7XG4gICAgICAgIHRoaXMudG9nZ2xlRGV2RGVwZW5kZW5jeShyZW1vdmVkVGVzdERlcGVuZGVuY2llcywgZmFsc2UpO1xuICAgIH1cblxuICAgIHB1YmxpYyBidWlsZERldkRlcGVuZGVuY2llcyhwYWNrYWdlSnNvbkRldkRlcGVuZGVuY2llczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3JlbW92ZWREZXZEZXBlbmRlbmNpZXMuZm9yRWFjaChkZXBlbmRlbmN5ID0+IHtcbiAgICAgICAgICAgIGlmIChwYWNrYWdlSnNvbkRldkRlcGVuZGVuY2llc1tkZXBlbmRlbmN5XSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYWNrYWdlSnNvbkRldkRlcGVuZGVuY2llc1tkZXBlbmRlbmN5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fcmVxdWlyZWREZXZEZXBlbmRlbmNpZXMuZm9yRWFjaChyZXF1aXJlZERlcGVuZGVuY3kgPT4ge1xuICAgICAgICAgICAgcGFja2FnZUpzb25EZXZEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XSA9IHRoaXMuZmluZERlcGVuZGVuY3lWZXJzaW9uKHJlcXVpcmVkRGVwZW5kZW5jeSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaW5kRGVwZW5kZW5jeVZlcnNpb24ocmVxdWlyZWREZXBlbmRlbmN5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAodGhpcy5lbmdpbmVQYWNrYWdlSnNvbiAmJiB0aGlzLmVuZ2luZVBhY2thZ2VKc29uLnBlZXJEZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVuZ2luZVBhY2thZ2VKc29uLnBlZXJEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVuZ2luZVBhY2thZ2VKc29uLnBlZXJEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIERlcGVuZGVuY3kgJyR7cmVxdWlyZWREZXBlbmRlbmN5fSdgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRlcGVuZGVuY3kgVmVyc2lvbnMgbWlzc2luZ1wiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==
