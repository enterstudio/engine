"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const uniteClientPackage_1 = require("../configuration/models/unite/uniteClientPackage");
class EngineVariables {
    constructor() {
        this._configuration = {};
        this._requiredDevDependencies = [];
        this._removedDevDependencies = [];
        this._requiredClientPackages = {};
        this._removedClientPackages = {};
    }
    setConfiguration(name, config) {
        this._configuration[name] = config;
    }
    getConfiguration(name) {
        return this._configuration[name];
    }
    setupDirectories(fileSystem, rootFolder) {
        this.rootFolder = rootFolder;
        this.wwwRootFolder = fileSystem.pathCombine(this.rootFolder, "www");
        this.packagedRootFolder = fileSystem.pathCombine(this.rootFolder, "packaged");
        this.www = {
            srcFolder: fileSystem.pathCombine(this.wwwRootFolder, "src"),
            distFolder: fileSystem.pathCombine(this.wwwRootFolder, "dist"),
            cssSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "cssSrc"),
            cssDistFolder: fileSystem.pathCombine(this.wwwRootFolder, "css"),
            e2eTestFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e"),
            e2eTestSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e/src"),
            e2eTestDistFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e/dist"),
            unitTestFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/unit"),
            unitTestSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/unit/src"),
            unitTestDistFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/unit/dist"),
            reportsFolder: fileSystem.pathCombine(this.wwwRootFolder, "test/reports"),
            assetsFolder: fileSystem.pathCombine(this.wwwRootFolder, "assets"),
            assetsSrcFolder: fileSystem.pathCombine(this.wwwRootFolder, "assetsSrc"),
            buildFolder: fileSystem.pathCombine(this.wwwRootFolder, "build"),
            packageFolder: fileSystem.pathCombine(this.wwwRootFolder, "node_modules")
        };
    }
    toggleClientPackage(name, main, mainMinified, preload, includeMode, isPackage, assets, required) {
        const clientPackage = new uniteClientPackage_1.UniteClientPackage();
        clientPackage.includeMode = includeMode;
        clientPackage.preload = preload;
        clientPackage.main = main;
        clientPackage.mainMinified = mainMinified;
        clientPackage.isPackage = isPackage;
        clientPackage.version = this.findDependencyVersion(name);
        clientPackage.assets = assets;
        let opArr;
        if (required) {
            opArr = this._requiredClientPackages;
        }
        else {
            opArr = this._removedClientPackages;
        }
        opArr[name] = clientPackage;
    }
    getTestClientPackages() {
        const packages = {};
        Object.keys(this._requiredClientPackages)
            .filter(key => this._requiredClientPackages[key].includeMode === "test" || this._requiredClientPackages[key].includeMode === "both")
            .forEach(key => {
            packages[key] = this._requiredClientPackages[key];
        });
        return packages;
    }
    toggleDevDependency(dependencies, required) {
        let opArr;
        if (required) {
            opArr = this._requiredDevDependencies;
        }
        else {
            opArr = this._removedDevDependencies;
        }
        dependencies.forEach(dep => {
            if (opArr.indexOf(dep) < 0) {
                opArr.push(dep);
            }
        });
    }
    buildDependencies(uniteConfiguration, packageJsonDependencies) {
        for (const key in this._removedClientPackages) {
            if (packageJsonDependencies[key]) {
                delete packageJsonDependencies[key];
            }
        }
        const addedTestDependencies = [];
        const removedTestDependencies = [];
        for (const pkg in this._requiredClientPackages) {
            uniteConfiguration.clientPackages[pkg] = this._requiredClientPackages[pkg];
            if (this._requiredClientPackages[pkg].includeMode === "app" || this._requiredClientPackages[pkg].includeMode === "both") {
                packageJsonDependencies[pkg] = this._requiredClientPackages[pkg].version;
                const idx = this._requiredDevDependencies.indexOf(pkg);
                if (idx >= 0) {
                    this._requiredDevDependencies.splice(idx, 1);
                    removedTestDependencies.push(pkg);
                }
            }
            else {
                addedTestDependencies.push(pkg);
            }
        }
        this.toggleDevDependency(addedTestDependencies, true);
        this.toggleDevDependency(removedTestDependencies, false);
    }
    buildDevDependencies(packageJsonDevDependencies) {
        this._removedDevDependencies.forEach(dependency => {
            if (packageJsonDevDependencies[dependency]) {
                delete packageJsonDevDependencies[dependency];
            }
        });
        this._requiredDevDependencies.forEach(requiredDependency => {
            packageJsonDevDependencies[requiredDependency] = this.findDependencyVersion(requiredDependency);
        });
    }
    findDependencyVersion(requiredDependency) {
        if (this.enginePackageJson && this.enginePackageJson.peerDependencies) {
            if (this.enginePackageJson.peerDependencies[requiredDependency]) {
                return this.enginePackageJson.peerDependencies[requiredDependency];
            }
            else {
                throw new Error(`Missing Dependency '${requiredDependency}'`);
            }
        }
        else {
            throw new Error("Dependency Versions missing");
        }
    }
}
exports.EngineVariables = EngineVariables;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbmdpbmUvZW5naW5lVmFyaWFibGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBT0EseUZBQXNGO0FBSXRGO0lBMENJO1FBQ0ksSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDLHdCQUF3QixHQUFHLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRU0sZ0JBQWdCLENBQUMsSUFBWSxFQUFFLE1BQVc7UUFDN0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUM7SUFDdkMsQ0FBQztJQUVNLGdCQUFnQixDQUFJLElBQVk7UUFDbkMsTUFBTSxDQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVNLGdCQUFnQixDQUFDLFVBQXVCLEVBQUUsVUFBa0I7UUFDL0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUM5RSxJQUFJLENBQUMsR0FBRyxHQUFHO1lBQ1AsU0FBUyxFQUFFLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUM7WUFDNUQsVUFBVSxFQUFFLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUM7WUFDOUQsWUFBWSxFQUFFLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUM7WUFDbEUsYUFBYSxFQUFFLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUM7WUFDaEUsYUFBYSxFQUFFLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUM7WUFDckUsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQztZQUM1RSxpQkFBaUIsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsZUFBZSxDQUFDO1lBQzlFLGNBQWMsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDO1lBQ3ZFLGlCQUFpQixFQUFFLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxlQUFlLENBQUM7WUFDOUUsa0JBQWtCLEVBQUUsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDO1lBQ2hGLGFBQWEsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDO1lBQ3pFLFlBQVksRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDO1lBQ2xFLGVBQWUsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDO1lBQ3hFLFdBQVcsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDO1lBQ2hFLGFBQWEsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDO1NBQzVFLENBQUM7SUFDTixDQUFDO0lBRU0sbUJBQW1CLENBQUMsSUFBWSxFQUNaLElBQVksRUFDWixZQUFvQixFQUNwQixPQUFnQixFQUNoQixXQUF3QixFQUN4QixTQUFrQixFQUNsQixNQUFjLEVBQ2QsUUFBaUI7UUFDeEMsTUFBTSxhQUFhLEdBQUcsSUFBSSx1Q0FBa0IsRUFBRSxDQUFDO1FBQy9DLGFBQWEsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQ3hDLGFBQWEsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ2hDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQzFCLGFBQWEsQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQzFDLGFBQWEsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQ3BDLGFBQWEsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pELGFBQWEsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRTlCLElBQUksS0FBMkMsQ0FBQztRQUNoRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ1gsS0FBSyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQztRQUN6QyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixLQUFLLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDO1FBQ3hDLENBQUM7UUFFRCxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBYSxDQUFDO0lBQ2hDLENBQUM7SUFFTSxxQkFBcUI7UUFDeEIsTUFBTSxRQUFRLEdBQTBDLEVBQUUsQ0FBQztRQUUzRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQzthQUNwQyxNQUFNLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEtBQUssTUFBTSxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEtBQUssTUFBTSxDQUFDO2FBQ25JLE9BQU8sQ0FBQyxHQUFHO1lBQ1IsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0RCxDQUFDLENBQUMsQ0FBQztRQUVQLE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVNLG1CQUFtQixDQUFDLFlBQXNCLEVBQUUsUUFBaUI7UUFDaEUsSUFBSSxLQUFlLENBQUM7UUFDcEIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNYLEtBQUssR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUM7UUFDMUMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osS0FBSyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQztRQUN6QyxDQUFDO1FBRUQsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHO1lBQ3BCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwQixDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0saUJBQWlCLENBQUMsa0JBQXNDLEVBQUUsdUJBQWlEO1FBQzlHLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7WUFDNUMsRUFBRSxDQUFDLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixPQUFPLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxxQkFBcUIsR0FBRyxFQUFFLENBQUM7UUFDakMsTUFBTSx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFDbkMsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUMsQ0FBQztZQUM3QyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDdEgsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFFekUsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDdkQsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ1gsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQzdDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDdEMsQ0FBQztZQUNMLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixxQkFBcUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDcEMsQ0FBQztRQUNMLENBQUM7UUFDRCxJQUFJLENBQUMsbUJBQW1CLENBQUMscUJBQXFCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFTSxvQkFBb0IsQ0FBQywwQkFBb0Q7UUFDNUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxVQUFVO1lBQzNDLEVBQUUsQ0FBQyxDQUFDLDBCQUEwQixDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekMsT0FBTywwQkFBMEIsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNsRCxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsd0JBQXdCLENBQUMsT0FBTyxDQUFDLGtCQUFrQjtZQUNwRCwwQkFBMEIsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3BHLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLHFCQUFxQixDQUFDLGtCQUEwQjtRQUNuRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztZQUNwRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUN2RSxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO1lBQ2xFLENBQUM7UUFDTCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDbkQsQ0FBQztJQUNMLENBQUM7Q0FDSjtBQTFMRCwwQ0EwTEMiLCJmaWxlIjoiZW5naW5lL2VuZ2luZVZhcmlhYmxlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVmFyaWFibGVzIHVzZWQgYnkgdGhlIGVuZ2luZS5cbiAqL1xuaW1wb3J0IHsgSUZpbGVTeXN0ZW0gfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9pbnRlcmZhY2VzL0lGaWxlU3lzdGVtXCI7XG5pbXBvcnQgeyBQYWNrYWdlQ29uZmlndXJhdGlvbiB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy9wYWNrYWdlcy9wYWNrYWdlQ29uZmlndXJhdGlvblwiO1xuaW1wb3J0IHsgSVNwZHhMaWNlbnNlIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3NwZHgvSVNwZHhMaWNlbnNlXCI7XG5pbXBvcnQgeyBJbmNsdWRlTW9kZSB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy91bml0ZS9pbmNsdWRlTW9kZVwiO1xuaW1wb3J0IHsgVW5pdGVDbGllbnRQYWNrYWdlIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3VuaXRlL3VuaXRlQ2xpZW50UGFja2FnZVwiO1xuaW1wb3J0IHsgVW5pdGVDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3VuaXRlL3VuaXRlQ29uZmlndXJhdGlvblwiO1xuaW1wb3J0IHsgSVBhY2thZ2VNYW5hZ2VyIH0gZnJvbSBcIi4uL2ludGVyZmFjZXMvSVBhY2thZ2VNYW5hZ2VyXCI7XG5cbmV4cG9ydCBjbGFzcyBFbmdpbmVWYXJpYWJsZXMge1xuICAgIHB1YmxpYyBlbmdpbmVSb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHVibGljIGVuZ2luZUFzc2V0c0ZvbGRlcjogc3RyaW5nO1xuICAgIHB1YmxpYyBlbmdpbmVQYWNrYWdlSnNvbjogUGFja2FnZUNvbmZpZ3VyYXRpb247XG5cbiAgICBwdWJsaWMgcm9vdEZvbGRlcjogc3RyaW5nO1xuICAgIHB1YmxpYyB3d3dSb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHVibGljIHBhY2thZ2VkUm9vdEZvbGRlcjogc3RyaW5nO1xuXG4gICAgcHVibGljIHd3dzoge1xuICAgICAgICBzcmNGb2xkZXI6IHN0cmluZztcbiAgICAgICAgZGlzdEZvbGRlcjogc3RyaW5nO1xuICAgICAgICB1bml0VGVzdEZvbGRlcjogc3RyaW5nO1xuICAgICAgICB1bml0VGVzdFNyY0ZvbGRlcjogc3RyaW5nO1xuICAgICAgICB1bml0VGVzdERpc3RGb2xkZXI6IHN0cmluZztcbiAgICAgICAgY3NzU3JjRm9sZGVyOiBzdHJpbmc7XG4gICAgICAgIGNzc0Rpc3RGb2xkZXI6IHN0cmluZztcbiAgICAgICAgZTJlVGVzdEZvbGRlcjogc3RyaW5nO1xuICAgICAgICBlMmVUZXN0U3JjRm9sZGVyOiBzdHJpbmc7XG4gICAgICAgIGUyZVRlc3REaXN0Rm9sZGVyOiBzdHJpbmc7XG4gICAgICAgIHJlcG9ydHNGb2xkZXI6IHN0cmluZztcbiAgICAgICAgcGFja2FnZUZvbGRlcjogc3RyaW5nO1xuICAgICAgICBidWlsZEZvbGRlcjogc3RyaW5nO1xuXG4gICAgICAgIGFzc2V0c0ZvbGRlcjogc3RyaW5nO1xuICAgICAgICBhc3NldHNTcmNGb2xkZXI6IHN0cmluZztcbiAgICB9O1xuXG4gICAgcHVibGljIHNvdXJjZUxhbmd1YWdlRXh0OiBzdHJpbmc7XG4gICAgcHVibGljIHN0eWxlTGFuZ3VhZ2VFeHQ6IHN0cmluZztcblxuICAgIHB1YmxpYyBsaWNlbnNlOiBJU3BkeExpY2Vuc2U7XG5cbiAgICBwdWJsaWMgcGFja2FnZU1hbmFnZXI6IElQYWNrYWdlTWFuYWdlcjtcblxuICAgIHByaXZhdGUgX2NvbmZpZ3VyYXRpb246IHsgW2lkOiBzdHJpbmddOiBhbnkgfTtcblxuICAgIHByaXZhdGUgX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzOiBzdHJpbmdbXTtcbiAgICBwcml2YXRlIF9yZW1vdmVkRGV2RGVwZW5kZW5jaWVzOiBzdHJpbmdbXTtcbiAgICBwcml2YXRlIF9yZXF1aXJlZENsaWVudFBhY2thZ2VzOiB7IFtpZDogc3RyaW5nXTogVW5pdGVDbGllbnRQYWNrYWdlIH07XG4gICAgcHJpdmF0ZSBfcmVtb3ZlZENsaWVudFBhY2thZ2VzOiB7IFtpZDogc3RyaW5nXTogVW5pdGVDbGllbnRQYWNrYWdlIH07XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbiA9IHt9O1xuXG4gICAgICAgIHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzID0gW107XG4gICAgICAgIHRoaXMuX3JlbW92ZWREZXZEZXBlbmRlbmNpZXMgPSBbXTtcbiAgICAgICAgdGhpcy5fcmVxdWlyZWRDbGllbnRQYWNrYWdlcyA9IHt9O1xuICAgICAgICB0aGlzLl9yZW1vdmVkQ2xpZW50UGFja2FnZXMgPSB7fTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0Q29uZmlndXJhdGlvbihuYW1lOiBzdHJpbmcsIGNvbmZpZzogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2NvbmZpZ3VyYXRpb25bbmFtZV0gPSBjb25maWc7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENvbmZpZ3VyYXRpb248VD4obmFtZTogc3RyaW5nKTogVCB7XG4gICAgICAgIHJldHVybiA8VD50aGlzLl9jb25maWd1cmF0aW9uW25hbWVdO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXR1cERpcmVjdG9yaWVzKGZpbGVTeXN0ZW06IElGaWxlU3lzdGVtLCByb290Rm9sZGVyOiBzdHJpbmcpIDogdm9pZCB7XG4gICAgICAgIHRoaXMucm9vdEZvbGRlciA9IHJvb3RGb2xkZXI7XG4gICAgICAgIHRoaXMud3d3Um9vdEZvbGRlciA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy5yb290Rm9sZGVyLCBcInd3d1wiKTtcbiAgICAgICAgdGhpcy5wYWNrYWdlZFJvb3RGb2xkZXIgPSBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMucm9vdEZvbGRlciwgXCJwYWNrYWdlZFwiKTtcbiAgICAgICAgdGhpcy53d3cgPSB7XG4gICAgICAgICAgICBzcmNGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInNyY1wiKSxcbiAgICAgICAgICAgIGRpc3RGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImRpc3RcIiksXG4gICAgICAgICAgICBjc3NTcmNGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImNzc1NyY1wiKSxcbiAgICAgICAgICAgIGNzc0Rpc3RGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImNzc1wiKSxcbiAgICAgICAgICAgIGUyZVRlc3RGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvZTJlXCIpLFxuICAgICAgICAgICAgZTJlVGVzdFNyY0ZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC9lMmUvc3JjXCIpLFxuICAgICAgICAgICAgZTJlVGVzdERpc3RGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvZTJlL2Rpc3RcIiksXG4gICAgICAgICAgICB1bml0VGVzdEZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC91bml0XCIpLFxuICAgICAgICAgICAgdW5pdFRlc3RTcmNGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvdW5pdC9zcmNcIiksXG4gICAgICAgICAgICB1bml0VGVzdERpc3RGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvdW5pdC9kaXN0XCIpLFxuICAgICAgICAgICAgcmVwb3J0c0ZvbGRlcjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC9yZXBvcnRzXCIpLFxuICAgICAgICAgICAgYXNzZXRzRm9sZGVyOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJhc3NldHNcIiksXG4gICAgICAgICAgICBhc3NldHNTcmNGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImFzc2V0c1NyY1wiKSxcbiAgICAgICAgICAgIGJ1aWxkRm9sZGVyOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJidWlsZFwiKSxcbiAgICAgICAgICAgIHBhY2thZ2VGb2xkZXI6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcIm5vZGVfbW9kdWxlc1wiKVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVDbGllbnRQYWNrYWdlKG5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbk1pbmlmaWVkOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlbG9hZDogYm9vbGVhbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdWRlTW9kZTogSW5jbHVkZU1vZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNQYWNrYWdlOiBib29sZWFuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0czogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNsaWVudFBhY2thZ2UgPSBuZXcgVW5pdGVDbGllbnRQYWNrYWdlKCk7XG4gICAgICAgIGNsaWVudFBhY2thZ2UuaW5jbHVkZU1vZGUgPSBpbmNsdWRlTW9kZTtcbiAgICAgICAgY2xpZW50UGFja2FnZS5wcmVsb2FkID0gcHJlbG9hZDtcbiAgICAgICAgY2xpZW50UGFja2FnZS5tYWluID0gbWFpbjtcbiAgICAgICAgY2xpZW50UGFja2FnZS5tYWluTWluaWZpZWQgPSBtYWluTWluaWZpZWQ7XG4gICAgICAgIGNsaWVudFBhY2thZ2UuaXNQYWNrYWdlID0gaXNQYWNrYWdlO1xuICAgICAgICBjbGllbnRQYWNrYWdlLnZlcnNpb24gPSB0aGlzLmZpbmREZXBlbmRlbmN5VmVyc2lvbihuYW1lKTtcbiAgICAgICAgY2xpZW50UGFja2FnZS5hc3NldHMgPSBhc3NldHM7XG5cbiAgICAgICAgbGV0IG9wQXJyOiB7IFtpZDogc3RyaW5nXTogVW5pdGVDbGllbnRQYWNrYWdlIH07XG4gICAgICAgIGlmIChyZXF1aXJlZCkge1xuICAgICAgICAgICAgb3BBcnIgPSB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3BBcnIgPSB0aGlzLl9yZW1vdmVkQ2xpZW50UGFja2FnZXM7XG4gICAgICAgIH1cblxuICAgICAgICBvcEFycltuYW1lXSA9IGNsaWVudFBhY2thZ2U7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRlc3RDbGllbnRQYWNrYWdlcygpOiB7IFtpZDogc3RyaW5nXSA6IFVuaXRlQ2xpZW50UGFja2FnZSB9IHtcbiAgICAgICAgY29uc3QgcGFja2FnZXM6IHsgW2lkOiBzdHJpbmddIDogVW5pdGVDbGllbnRQYWNrYWdlIH0gPSB7fTtcblxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzKVxuICAgICAgICAgICAgLmZpbHRlcihrZXkgPT4gdGhpcy5fcmVxdWlyZWRDbGllbnRQYWNrYWdlc1trZXldLmluY2x1ZGVNb2RlID09PSBcInRlc3RcIiB8fCB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW2tleV0uaW5jbHVkZU1vZGUgPT09IFwiYm90aFwiKVxuICAgICAgICAgICAgLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgICAgICBwYWNrYWdlc1trZXldID0gdGhpcy5fcmVxdWlyZWRDbGllbnRQYWNrYWdlc1trZXldO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHBhY2thZ2VzO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVEZXZEZXBlbmRlbmN5KGRlcGVuZGVuY2llczogc3RyaW5nW10sIHJlcXVpcmVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGxldCBvcEFycjogc3RyaW5nW107XG4gICAgICAgIGlmIChyZXF1aXJlZCkge1xuICAgICAgICAgICAgb3BBcnIgPSB0aGlzLl9yZXF1aXJlZERldkRlcGVuZGVuY2llcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9wQXJyID0gdGhpcy5fcmVtb3ZlZERldkRlcGVuZGVuY2llcztcbiAgICAgICAgfVxuXG4gICAgICAgIGRlcGVuZGVuY2llcy5mb3JFYWNoKGRlcCA9PiB7XG4gICAgICAgICAgICBpZiAob3BBcnIuaW5kZXhPZihkZXApIDwgMCkge1xuICAgICAgICAgICAgICAgIG9wQXJyLnB1c2goZGVwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGJ1aWxkRGVwZW5kZW5jaWVzKHVuaXRlQ29uZmlndXJhdGlvbjogVW5pdGVDb25maWd1cmF0aW9uLCBwYWNrYWdlSnNvbkRlcGVuZGVuY2llczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9KTogdm9pZCB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3JlbW92ZWRDbGllbnRQYWNrYWdlcykge1xuICAgICAgICAgICAgaWYgKHBhY2thZ2VKc29uRGVwZW5kZW5jaWVzW2tleV0pIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgcGFja2FnZUpzb25EZXBlbmRlbmNpZXNba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGFkZGVkVGVzdERlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICBjb25zdCByZW1vdmVkVGVzdERlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHBrZyBpbiB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzKSB7XG4gICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb24uY2xpZW50UGFja2FnZXNbcGtnXSA9IHRoaXMuX3JlcXVpcmVkQ2xpZW50UGFja2FnZXNbcGtnXTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW3BrZ10uaW5jbHVkZU1vZGUgPT09IFwiYXBwXCIgfHwgdGhpcy5fcmVxdWlyZWRDbGllbnRQYWNrYWdlc1twa2ddLmluY2x1ZGVNb2RlID09PSBcImJvdGhcIikge1xuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uRGVwZW5kZW5jaWVzW3BrZ10gPSB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW3BrZ10udmVyc2lvbjtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzLmluZGV4T2YocGtnKTtcbiAgICAgICAgICAgICAgICBpZiAoaWR4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVxdWlyZWREZXZEZXBlbmRlbmNpZXMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZWRUZXN0RGVwZW5kZW5jaWVzLnB1c2gocGtnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkZGVkVGVzdERlcGVuZGVuY2llcy5wdXNoKHBrZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50b2dnbGVEZXZEZXBlbmRlbmN5KGFkZGVkVGVzdERlcGVuZGVuY2llcywgdHJ1ZSk7XG4gICAgICAgIHRoaXMudG9nZ2xlRGV2RGVwZW5kZW5jeShyZW1vdmVkVGVzdERlcGVuZGVuY2llcywgZmFsc2UpO1xuICAgIH1cblxuICAgIHB1YmxpYyBidWlsZERldkRlcGVuZGVuY2llcyhwYWNrYWdlSnNvbkRldkRlcGVuZGVuY2llczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3JlbW92ZWREZXZEZXBlbmRlbmNpZXMuZm9yRWFjaChkZXBlbmRlbmN5ID0+IHtcbiAgICAgICAgICAgIGlmIChwYWNrYWdlSnNvbkRldkRlcGVuZGVuY2llc1tkZXBlbmRlbmN5XSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYWNrYWdlSnNvbkRldkRlcGVuZGVuY2llc1tkZXBlbmRlbmN5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fcmVxdWlyZWREZXZEZXBlbmRlbmNpZXMuZm9yRWFjaChyZXF1aXJlZERlcGVuZGVuY3kgPT4ge1xuICAgICAgICAgICAgcGFja2FnZUpzb25EZXZEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XSA9IHRoaXMuZmluZERlcGVuZGVuY3lWZXJzaW9uKHJlcXVpcmVkRGVwZW5kZW5jeSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaW5kRGVwZW5kZW5jeVZlcnNpb24ocmVxdWlyZWREZXBlbmRlbmN5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAodGhpcy5lbmdpbmVQYWNrYWdlSnNvbiAmJiB0aGlzLmVuZ2luZVBhY2thZ2VKc29uLnBlZXJEZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVuZ2luZVBhY2thZ2VKc29uLnBlZXJEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVuZ2luZVBhY2thZ2VKc29uLnBlZXJEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIERlcGVuZGVuY3kgJyR7cmVxdWlyZWREZXBlbmRlbmN5fSdgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRlcGVuZGVuY3kgVmVyc2lvbnMgbWlzc2luZ1wiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==
