"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const uniteClientPackage_1 = require("../configuration/models/unite/uniteClientPackage");
class EngineVariables {
    constructor() {
        this._configuration = {};
        this.syntheticImport = "";
        this.moduleId = "";
        this.buildTranspileInclude = [];
        this.buildTranspilePreBuild = [];
        this.buildTranspilePostBuild = [];
        this._requiredDevDependencies = {};
        this._removedDevDependencies = {};
        this._requiredClientPackages = {};
        this._removedClientPackages = {};
        this._existingClientPackages = {};
        this.additionalCompletionMessages = [];
    }
    setConfiguration(name, config) {
        this._configuration[name] = config;
    }
    getConfiguration(name) {
        return this._configuration[name];
    }
    setupDirectories(fileSystem, rootFolder) {
        this.rootFolder = rootFolder;
        this.wwwRootFolder = fileSystem.pathCombine(this.rootFolder, "www");
        this.packagedRootFolder = fileSystem.pathCombine(this.rootFolder, "packaged");
        this.platformRootFolder = fileSystem.pathCombine(this.rootFolder, "platform");
        this.docsRootFolder = fileSystem.pathCombine(this.rootFolder, "docs");
        this.www = {
            src: fileSystem.pathCombine(this.wwwRootFolder, "src"),
            dist: fileSystem.pathCombine(this.wwwRootFolder, "dist"),
            css: fileSystem.pathCombine(this.wwwRootFolder, "cssSrc"),
            cssDist: fileSystem.pathCombine(this.wwwRootFolder, "css"),
            e2eRoot: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e"),
            e2e: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e/src"),
            e2eDist: fileSystem.pathCombine(this.wwwRootFolder, "test/e2e/dist"),
            unitRoot: fileSystem.pathCombine(this.wwwRootFolder, "test/unit"),
            unit: fileSystem.pathCombine(this.wwwRootFolder, "test/unit/src"),
            unitDist: fileSystem.pathCombine(this.wwwRootFolder, "test/unit/dist"),
            reports: fileSystem.pathCombine(this.wwwRootFolder, "test/reports"),
            assets: fileSystem.pathCombine(this.wwwRootFolder, "assets"),
            assetsSrc: fileSystem.pathCombine(this.wwwRootFolder, "assetsSrc"),
            build: fileSystem.pathCombine(this.wwwRootFolder, "build"),
            package: fileSystem.pathCombine(this.wwwRootFolder, "node_modules"),
            configuration: fileSystem.pathCombine(this.wwwRootFolder, "configuration")
        };
    }
    initialisePackages(clientPackages) {
        this._existingClientPackages = clientPackages;
    }
    toggleClientPackage(key, clientPackage, required) {
        if (required) {
            this.addClientPackage(key, clientPackage);
        }
        else {
            this.removeClientPackage(key, clientPackage);
        }
    }
    addClientPackage(key, clientPackage) {
        if (!clientPackage.version) {
            clientPackage.version = this.findDependencyVersion(clientPackage.name);
        }
        this._requiredClientPackages[key] = clientPackage;
    }
    removeClientPackage(key, clientPackage) {
        this._removedClientPackages[key] = clientPackage;
    }
    toggleDevDependency(dependencies, required) {
        if (required) {
            this.addDevDependency(dependencies);
        }
        else {
            this.removeDevDependency(dependencies);
        }
    }
    addDevDependency(dependencies) {
        dependencies.forEach(dep => {
            const clientPackage = new uniteClientPackage_1.UniteClientPackage();
            clientPackage.name = dep;
            this._requiredDevDependencies[dep] = clientPackage;
        });
    }
    removeDevDependency(dependencies) {
        dependencies.forEach(dep => {
            const clientPackage = new uniteClientPackage_1.UniteClientPackage();
            clientPackage.name = dep;
            this._removedDevDependencies[dep] = clientPackage;
        });
    }
    addVersionedDevDependency(dependency, version) {
        const clientPackage = new uniteClientPackage_1.UniteClientPackage();
        clientPackage.name = dependency;
        clientPackage.version = version;
        this._requiredDevDependencies[dependency] = clientPackage;
    }
    buildDependencies(uniteConfiguration, packageJsonDependencies) {
        for (const key in this._removedClientPackages) {
            const pkg = this._removedClientPackages[key];
            if (packageJsonDependencies[pkg.name]) {
                delete packageJsonDependencies[pkg.name];
            }
            if (this._existingClientPackages[key] &&
                !this._existingClientPackages[key].hasOverrides) {
                delete this._existingClientPackages[key];
            }
        }
        for (const key in this._existingClientPackages) {
            const pkg = this._existingClientPackages[key];
            if (pkg.hasOverrides || !this._requiredClientPackages[key]) {
                this._requiredClientPackages[key] = pkg;
            }
        }
        const addedDevDependencies = [];
        const removedDevDependencies = [];
        for (const key in this._requiredClientPackages) {
            const pkg = this._requiredClientPackages[key];
            uniteConfiguration.clientPackages[key] = pkg;
            if (pkg.includeMode === undefined || pkg.includeMode === "app" || pkg.includeMode === "both") {
                packageJsonDependencies[pkg.name] = pkg.version;
                if (this._requiredDevDependencies[pkg.name]) {
                    delete this._requiredDevDependencies[pkg.name];
                }
                removedDevDependencies.push(pkg.name);
            }
            else {
                addedDevDependencies.push(pkg.name);
            }
        }
        this.toggleDevDependency(addedDevDependencies, true);
        this.toggleDevDependency(removedDevDependencies, false);
    }
    buildDevDependencies(packageJsonDevDependencies) {
        Object.keys(this._removedDevDependencies).forEach(dependency => {
            if (packageJsonDevDependencies[dependency]) {
                delete packageJsonDevDependencies[dependency];
            }
        });
        Object.keys(this._requiredDevDependencies).forEach(requiredDependency => {
            if (this._requiredDevDependencies[requiredDependency].version) {
                packageJsonDevDependencies[requiredDependency] = this._requiredDevDependencies[requiredDependency].version;
            }
            else {
                packageJsonDevDependencies[requiredDependency] = this.findDependencyVersion(requiredDependency);
            }
        });
    }
    findDependencyVersion(requiredDependency) {
        if (this.engineDependencies) {
            if (this.engineDependencies[requiredDependency]) {
                return this.engineDependencies[requiredDependency];
            }
            else {
                throw new Error(`Missing Dependency '${requiredDependency}'`);
            }
        }
        else {
            throw new Error("Dependency Versions missing");
        }
    }
}
exports.EngineVariables = EngineVariables;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbmdpbmUvZW5naW5lVmFyaWFibGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBSUEseUZBQXNGO0FBS3RGO0lBdURJO1FBQ0ksSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFFbkIsSUFBSSxDQUFDLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFFbEMsSUFBSSxDQUFDLHdCQUF3QixHQUFHLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztRQUNqQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsRUFBRSxDQUFDO1FBRWxDLElBQUksQ0FBQyw0QkFBNEIsR0FBRyxFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUVNLGdCQUFnQixDQUFDLElBQVksRUFBRSxNQUFXO1FBQzdDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDO0lBQ3ZDLENBQUM7SUFFTSxnQkFBZ0IsQ0FBSSxJQUFZO1FBQ25DLE1BQU0sQ0FBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxVQUF1QixFQUFFLFVBQWtCO1FBQy9ELElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFD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R0FBRyxDQUFDLENBQUM7WUFDbEUsQ0FBQztRQUNMLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE1BQU0sSUFBSSxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUNuRCxDQUFDO0lBQ0wsQ0FBQztDQUNKO0FBeE9ELDBDQXdPQyIsImZpbGUiOiJlbmdpbmUvZW5naW5lVmFyaWFibGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBWYXJpYWJsZXMgdXNlZCBieSB0aGUgZW5naW5lLlxuICovXG5pbXBvcnQgeyBJRmlsZVN5c3RlbSB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2ludGVyZmFjZXMvSUZpbGVTeXN0ZW1cIjtcbmltcG9ydCB7IFVuaXRlQ2xpZW50UGFja2FnZSB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy91bml0ZS91bml0ZUNsaWVudFBhY2thZ2VcIjtcbmltcG9ydCB7IFVuaXRlQ29uZmlndXJhdGlvbiB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy91bml0ZS91bml0ZUNvbmZpZ3VyYXRpb25cIjtcbmltcG9ydCB7IElQYWNrYWdlTWFuYWdlciB9IGZyb20gXCIuLi9pbnRlcmZhY2VzL0lQYWNrYWdlTWFuYWdlclwiO1xuaW1wb3J0IHsgRW5naW5lVmFyaWFibGVzTWV0YSB9IGZyb20gXCIuL2VuZ2luZVZhcmlhYmxlc01ldGFcIjtcblxuZXhwb3J0IGNsYXNzIEVuZ2luZVZhcmlhYmxlcyB7XG4gICAgcHVibGljIG1ldGE6IEVuZ2luZVZhcmlhYmxlc01ldGE7XG4gICAgcHVibGljIGZvcmNlOiBib29sZWFuO1xuICAgIHB1YmxpYyBub0NyZWF0ZVNvdXJjZTogYm9vbGVhbjtcblxuICAgIHB1YmxpYyBlbmdpbmVSb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHVibGljIGVuZ2luZUFzc2V0c0ZvbGRlcjogc3RyaW5nO1xuICAgIHB1YmxpYyBlbmdpbmVWZXJzaW9uOiBzdHJpbmc7XG4gICAgcHVibGljIGVuZ2luZURlcGVuZGVuY2llczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9O1xuXG4gICAgcHVibGljIHJvb3RGb2xkZXI6IHN0cmluZztcbiAgICBwdWJsaWMgd3d3Um9vdEZvbGRlcjogc3RyaW5nO1xuICAgIHB1YmxpYyBwYWNrYWdlZFJvb3RGb2xkZXI6IHN0cmluZztcbiAgICBwdWJsaWMgcGxhdGZvcm1Sb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHVibGljIGRvY3NSb290Rm9sZGVyOiBzdHJpbmc7XG5cbiAgICBwdWJsaWMgd3d3OiB7XG4gICAgICAgIFtpZDogc3RyaW5nXTogc3RyaW5nO1xuICAgICAgICBzcmM6IHN0cmluZztcbiAgICAgICAgZGlzdDogc3RyaW5nO1xuICAgICAgICB1bml0Um9vdDogc3RyaW5nO1xuICAgICAgICB1bml0OiBzdHJpbmc7XG4gICAgICAgIHVuaXREaXN0OiBzdHJpbmc7XG4gICAgICAgIGNzczogc3RyaW5nO1xuICAgICAgICBjc3NEaXN0OiBzdHJpbmc7XG4gICAgICAgIGUyZVJvb3Q6IHN0cmluZztcbiAgICAgICAgZTJlOiBzdHJpbmc7XG4gICAgICAgIGUyZURpc3Q6IHN0cmluZztcbiAgICAgICAgcmVwb3J0czogc3RyaW5nO1xuICAgICAgICBwYWNrYWdlOiBzdHJpbmc7XG4gICAgICAgIGJ1aWxkOiBzdHJpbmc7XG4gICAgICAgIGNvbmZpZ3VyYXRpb246IHN0cmluZztcblxuICAgICAgICBhc3NldHM6IHN0cmluZztcbiAgICAgICAgYXNzZXRzU3JjOiBzdHJpbmc7XG4gICAgfTtcblxuICAgIHB1YmxpYyBidWlsZFRyYW5zcGlsZUluY2x1ZGU6IHN0cmluZ1tdO1xuICAgIHB1YmxpYyBidWlsZFRyYW5zcGlsZVByZUJ1aWxkOiBzdHJpbmdbXTtcbiAgICBwdWJsaWMgYnVpbGRUcmFuc3BpbGVQb3N0QnVpbGQ6IHN0cmluZ1tdO1xuXG4gICAgcHVibGljIHN5bnRoZXRpY0ltcG9ydDogc3RyaW5nO1xuICAgIHB1YmxpYyBtb2R1bGVJZDogc3RyaW5nO1xuXG4gICAgcHVibGljIHBhY2thZ2VNYW5hZ2VyOiBJUGFja2FnZU1hbmFnZXI7XG4gICAgcHVibGljIGFkZGl0aW9uYWxDb21wbGV0aW9uTWVzc2FnZXM6IHN0cmluZ1tdO1xuXG4gICAgcHJpdmF0ZSBfY29uZmlndXJhdGlvbjogeyBbaWQ6IHN0cmluZ106IGFueSB9O1xuXG4gICAgcHJpdmF0ZSBfcmVxdWlyZWREZXZEZXBlbmRlbmNpZXM6IHsgW2lkOiBzdHJpbmddOiBVbml0ZUNsaWVudFBhY2thZ2UgfTtcbiAgICBwcml2YXRlIF9yZW1vdmVkRGV2RGVwZW5kZW5jaWVzOiB7IFtpZDogc3RyaW5nXTogVW5pdGVDbGllbnRQYWNrYWdlIH07XG4gICAgcHJpdmF0ZSBfcmVxdWlyZWRDbGllbnRQYWNrYWdlczogeyBbaWQ6IHN0cmluZ106IFVuaXRlQ2xpZW50UGFja2FnZSB9O1xuICAgIHByaXZhdGUgX3JlbW92ZWRDbGllbnRQYWNrYWdlczogeyBbaWQ6IHN0cmluZ106IFVuaXRlQ2xpZW50UGFja2FnZSB9O1xuICAgIHByaXZhdGUgX2V4aXN0aW5nQ2xpZW50UGFja2FnZXM6IHsgW2lkOiBzdHJpbmddOiBVbml0ZUNsaWVudFBhY2thZ2UgfTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLl9jb25maWd1cmF0aW9uID0ge307XG5cbiAgICAgICAgdGhpcy5zeW50aGV0aWNJbXBvcnQgPSBcIlwiO1xuICAgICAgICB0aGlzLm1vZHVsZUlkID0gXCJcIjtcblxuICAgICAgICB0aGlzLmJ1aWxkVHJhbnNwaWxlSW5jbHVkZSA9IFtdO1xuICAgICAgICB0aGlzLmJ1aWxkVHJhbnNwaWxlUHJlQnVpbGQgPSBbXTtcbiAgICAgICAgdGhpcy5idWlsZFRyYW5zcGlsZVBvc3RCdWlsZCA9IFtdO1xuXG4gICAgICAgIHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzID0ge307XG4gICAgICAgIHRoaXMuX3JlbW92ZWREZXZEZXBlbmRlbmNpZXMgPSB7fTtcbiAgICAgICAgdGhpcy5fcmVxdWlyZWRDbGllbnRQYWNrYWdlcyA9IHt9O1xuICAgICAgICB0aGlzLl9yZW1vdmVkQ2xpZW50UGFja2FnZXMgPSB7fTtcbiAgICAgICAgdGhpcy5fZXhpc3RpbmdDbGllbnRQYWNrYWdlcyA9IHt9O1xuXG4gICAgICAgIHRoaXMuYWRkaXRpb25hbENvbXBsZXRpb25NZXNzYWdlcyA9IFtdO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDb25maWd1cmF0aW9uKG5hbWU6IHN0cmluZywgY29uZmlnOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbltuYW1lXSA9IGNvbmZpZztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q29uZmlndXJhdGlvbjxUPihuYW1lOiBzdHJpbmcpOiBUIHtcbiAgICAgICAgcmV0dXJuIDxUPnRoaXMuX2NvbmZpZ3VyYXRpb25bbmFtZV07XG4gICAgfVxuXG4gICAgcHVibGljIHNldHVwRGlyZWN0b3JpZXMoZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sIHJvb3RGb2xkZXI6IHN0cmluZykgOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yb290Rm9sZGVyID0gcm9vdEZvbGRlcjtcbiAgICAgICAgdGhpcy53d3dSb290Rm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnJvb3RGb2xkZXIsIFwid3d3XCIpO1xuICAgICAgICB0aGlzLnBhY2thZ2VkUm9vdEZvbGRlciA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy5yb290Rm9sZGVyLCBcInBhY2thZ2VkXCIpO1xuICAgICAgICB0aGlzLnBsYXRmb3JtUm9vdEZvbGRlciA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy5yb290Rm9sZGVyLCBcInBsYXRmb3JtXCIpO1xuICAgICAgICB0aGlzLmRvY3NSb290Rm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnJvb3RGb2xkZXIsIFwiZG9jc1wiKTtcbiAgICAgICAgdGhpcy53d3cgPSB7XG4gICAgICAgICAgICBzcmM6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInNyY1wiKSxcbiAgICAgICAgICAgIGRpc3Q6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImRpc3RcIiksXG4gICAgICAgICAgICBjc3M6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImNzc1NyY1wiKSxcbiAgICAgICAgICAgIGNzc0Rpc3Q6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImNzc1wiKSxcbiAgICAgICAgICAgIGUyZVJvb3Q6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvZTJlXCIpLFxuICAgICAgICAgICAgZTJlOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJ0ZXN0L2UyZS9zcmNcIiksXG4gICAgICAgICAgICBlMmVEaXN0OiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJ0ZXN0L2UyZS9kaXN0XCIpLFxuICAgICAgICAgICAgdW5pdFJvb3Q6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvdW5pdFwiKSxcbiAgICAgICAgICAgIHVuaXQ6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcInRlc3QvdW5pdC9zcmNcIiksXG4gICAgICAgICAgICB1bml0RGlzdDogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwidGVzdC91bml0L2Rpc3RcIiksXG4gICAgICAgICAgICByZXBvcnRzOiBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMud3d3Um9vdEZvbGRlciwgXCJ0ZXN0L3JlcG9ydHNcIiksXG4gICAgICAgICAgICBhc3NldHM6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImFzc2V0c1wiKSxcbiAgICAgICAgICAgIGFzc2V0c1NyYzogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwiYXNzZXRzU3JjXCIpLFxuICAgICAgICAgICAgYnVpbGQ6IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy53d3dSb290Rm9sZGVyLCBcImJ1aWxkXCIpLFxuICAgICAgICAgICAgcGFja2FnZTogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwibm9kZV9tb2R1bGVzXCIpLFxuICAgICAgICAgICAgY29uZmlndXJhdGlvbjogZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh0aGlzLnd3d1Jvb3RGb2xkZXIsIFwiY29uZmlndXJhdGlvblwiKVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBpbml0aWFsaXNlUGFja2FnZXMoY2xpZW50UGFja2FnZXM6IHsgW2lkOiBzdHJpbmddOiBVbml0ZUNsaWVudFBhY2thZ2UgfSk6IHZvaWQge1xuICAgICAgICB0aGlzLl9leGlzdGluZ0NsaWVudFBhY2thZ2VzID0gY2xpZW50UGFja2FnZXM7XG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZUNsaWVudFBhY2thZ2Uoa2V5OiBzdHJpbmcsIGNsaWVudFBhY2thZ2U6IFVuaXRlQ2xpZW50UGFja2FnZSwgcmVxdWlyZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgaWYgKHJlcXVpcmVkKSB7XG4gICAgICAgICAgICB0aGlzLmFkZENsaWVudFBhY2thZ2Uoa2V5LCBjbGllbnRQYWNrYWdlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2xpZW50UGFja2FnZShrZXksIGNsaWVudFBhY2thZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFkZENsaWVudFBhY2thZ2Uoa2V5OiBzdHJpbmcsIGNsaWVudFBhY2thZ2U6IFVuaXRlQ2xpZW50UGFja2FnZSk6IHZvaWQge1xuICAgICAgICBpZiAoIWNsaWVudFBhY2thZ2UudmVyc2lvbikge1xuICAgICAgICAgICAgY2xpZW50UGFja2FnZS52ZXJzaW9uID0gdGhpcy5maW5kRGVwZW5kZW5jeVZlcnNpb24oY2xpZW50UGFja2FnZS5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW2tleV0gPSBjbGllbnRQYWNrYWdlO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVDbGllbnRQYWNrYWdlKGtleTogc3RyaW5nLCBjbGllbnRQYWNrYWdlOiBVbml0ZUNsaWVudFBhY2thZ2UpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fcmVtb3ZlZENsaWVudFBhY2thZ2VzW2tleV0gPSBjbGllbnRQYWNrYWdlO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVEZXZEZXBlbmRlbmN5KGRlcGVuZGVuY2llczogc3RyaW5nW10sIHJlcXVpcmVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGlmIChyZXF1aXJlZCkge1xuICAgICAgICAgICAgdGhpcy5hZGREZXZEZXBlbmRlbmN5KGRlcGVuZGVuY2llcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZURldkRlcGVuZGVuY3koZGVwZW5kZW5jaWVzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhZGREZXZEZXBlbmRlbmN5KGRlcGVuZGVuY2llczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgZGVwZW5kZW5jaWVzLmZvckVhY2goZGVwID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudFBhY2thZ2UgPSBuZXcgVW5pdGVDbGllbnRQYWNrYWdlKCk7XG4gICAgICAgICAgICBjbGllbnRQYWNrYWdlLm5hbWUgPSBkZXA7XG4gICAgICAgICAgICB0aGlzLl9yZXF1aXJlZERldkRlcGVuZGVuY2llc1tkZXBdID0gY2xpZW50UGFja2FnZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZURldkRlcGVuZGVuY3koZGVwZW5kZW5jaWVzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgICAgICBkZXBlbmRlbmNpZXMuZm9yRWFjaChkZXAgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2xpZW50UGFja2FnZSA9IG5ldyBVbml0ZUNsaWVudFBhY2thZ2UoKTtcbiAgICAgICAgICAgIGNsaWVudFBhY2thZ2UubmFtZSA9IGRlcDtcbiAgICAgICAgICAgIHRoaXMuX3JlbW92ZWREZXZEZXBlbmRlbmNpZXNbZGVwXSA9IGNsaWVudFBhY2thZ2U7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRWZXJzaW9uZWREZXZEZXBlbmRlbmN5KGRlcGVuZGVuY3k6IHN0cmluZywgdmVyc2lvbjogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNsaWVudFBhY2thZ2UgPSBuZXcgVW5pdGVDbGllbnRQYWNrYWdlKCk7XG4gICAgICAgIGNsaWVudFBhY2thZ2UubmFtZSA9IGRlcGVuZGVuY3k7XG4gICAgICAgIGNsaWVudFBhY2thZ2UudmVyc2lvbiA9IHZlcnNpb247XG4gICAgICAgIHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzW2RlcGVuZGVuY3ldID0gY2xpZW50UGFja2FnZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYnVpbGREZXBlbmRlbmNpZXModW5pdGVDb25maWd1cmF0aW9uOiBVbml0ZUNvbmZpZ3VyYXRpb24sIHBhY2thZ2VKc29uRGVwZW5kZW5jaWVzOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nIH0pOiB2b2lkIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5fcmVtb3ZlZENsaWVudFBhY2thZ2VzKSB7XG4gICAgICAgICAgICBjb25zdCBwa2cgPSB0aGlzLl9yZW1vdmVkQ2xpZW50UGFja2FnZXNba2V5XTtcblxuICAgICAgICAgICAgaWYgKHBhY2thZ2VKc29uRGVwZW5kZW5jaWVzW3BrZy5uYW1lXSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYWNrYWdlSnNvbkRlcGVuZGVuY2llc1twa2cubmFtZV07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLl9leGlzdGluZ0NsaWVudFBhY2thZ2VzW2tleV0gJiZcbiAgICAgICAgICAgICAgICAhdGhpcy5fZXhpc3RpbmdDbGllbnRQYWNrYWdlc1trZXldLmhhc092ZXJyaWRlcykge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9leGlzdGluZ0NsaWVudFBhY2thZ2VzW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLl9leGlzdGluZ0NsaWVudFBhY2thZ2VzKSB7XG4gICAgICAgICAgICBjb25zdCBwa2cgPSB0aGlzLl9leGlzdGluZ0NsaWVudFBhY2thZ2VzW2tleV07XG5cbiAgICAgICAgICAgIGlmIChwa2cuaGFzT3ZlcnJpZGVzIHx8ICF0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW2tleV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9yZXF1aXJlZENsaWVudFBhY2thZ2VzW2tleV0gPSBwa2c7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhZGRlZERldkRlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICBjb25zdCByZW1vdmVkRGV2RGVwZW5kZW5jaWVzID0gW107XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3JlcXVpcmVkQ2xpZW50UGFja2FnZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHBrZyA9IHRoaXMuX3JlcXVpcmVkQ2xpZW50UGFja2FnZXNba2V5XTtcblxuICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uLmNsaWVudFBhY2thZ2VzW2tleV0gPSBwa2c7XG4gICAgICAgICAgICBpZiAocGtnLmluY2x1ZGVNb2RlID09PSB1bmRlZmluZWQgfHwgcGtnLmluY2x1ZGVNb2RlID09PSBcImFwcFwiIHx8IHBrZy5pbmNsdWRlTW9kZSA9PT0gXCJib3RoXCIpIHtcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvbkRlcGVuZGVuY2llc1twa2cubmFtZV0gPSBwa2cudmVyc2lvbjtcblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZXF1aXJlZERldkRlcGVuZGVuY2llc1twa2cubmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzW3BrZy5uYW1lXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVtb3ZlZERldkRlcGVuZGVuY2llcy5wdXNoKHBrZy5uYW1lKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWRkZWREZXZEZXBlbmRlbmNpZXMucHVzaChwa2cubmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50b2dnbGVEZXZEZXBlbmRlbmN5KGFkZGVkRGV2RGVwZW5kZW5jaWVzLCB0cnVlKTtcbiAgICAgICAgdGhpcy50b2dnbGVEZXZEZXBlbmRlbmN5KHJlbW92ZWREZXZEZXBlbmRlbmNpZXMsIGZhbHNlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYnVpbGREZXZEZXBlbmRlbmNpZXMocGFja2FnZUpzb25EZXZEZXBlbmRlbmNpZXM6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmcgfSk6IHZvaWQge1xuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9yZW1vdmVkRGV2RGVwZW5kZW5jaWVzKS5mb3JFYWNoKGRlcGVuZGVuY3kgPT4ge1xuICAgICAgICAgICAgaWYgKHBhY2thZ2VKc29uRGV2RGVwZW5kZW5jaWVzW2RlcGVuZGVuY3ldKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHBhY2thZ2VKc29uRGV2RGVwZW5kZW5jaWVzW2RlcGVuZGVuY3ldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9yZXF1aXJlZERldkRlcGVuZGVuY2llcykuZm9yRWFjaChyZXF1aXJlZERlcGVuZGVuY3kgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX3JlcXVpcmVkRGV2RGVwZW5kZW5jaWVzW3JlcXVpcmVkRGVwZW5kZW5jeV0udmVyc2lvbikge1xuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uRGV2RGVwZW5kZW5jaWVzW3JlcXVpcmVkRGVwZW5kZW5jeV0gPSB0aGlzLl9yZXF1aXJlZERldkRlcGVuZGVuY2llc1tyZXF1aXJlZERlcGVuZGVuY3ldLnZlcnNpb247XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uRGV2RGVwZW5kZW5jaWVzW3JlcXVpcmVkRGVwZW5kZW5jeV0gPSB0aGlzLmZpbmREZXBlbmRlbmN5VmVyc2lvbihyZXF1aXJlZERlcGVuZGVuY3kpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmluZERlcGVuZGVuY3lWZXJzaW9uKHJlcXVpcmVkRGVwZW5kZW5jeTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHRoaXMuZW5naW5lRGVwZW5kZW5jaWVzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5lbmdpbmVEZXBlbmRlbmNpZXNbcmVxdWlyZWREZXBlbmRlbmN5XSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVuZ2luZURlcGVuZGVuY2llc1tyZXF1aXJlZERlcGVuZGVuY3ldO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgRGVwZW5kZW5jeSAnJHtyZXF1aXJlZERlcGVuZGVuY3l9J2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRGVwZW5kZW5jeSBWZXJzaW9ucyBtaXNzaW5nXCIpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19
