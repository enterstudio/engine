"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const pipelineStepBase_1 = require("../engine/pipelineStepBase");
const templateHelper_1 = require("../helpers/templateHelper");
class SharedAppFramework extends pipelineStepBase_1.PipelineStepBase {
    generateAppSource(logger, fileSystem, uniteConfiguration, engineVariables, files, isShared) {
        return __awaiter(this, void 0, void 0, function* () {
            const appFramework = isShared ? "shared" : uniteConfiguration.applicationFramework.toLowerCase();
            const scaffoldFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${appFramework}/src/${uniteConfiguration.sourceLanguage.toLowerCase()}`);
            logger.info("Generating App Source in", { appSourceFolder: engineVariables.www.src });
            for (const file of files) {
                const ret = yield this.copyFile(logger, fileSystem, scaffoldFolder, file, engineVariables.www.src, file, engineVariables.force, engineVariables.noCreateSource, templateHelper_1.TemplateHelper.createCodeSubstitutions(engineVariables));
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    generateAppHtml(logger, fileSystem, uniteConfiguration, engineVariables, htmlFiles) {
        return __awaiter(this, void 0, void 0, function* () {
            const scaffoldFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${uniteConfiguration.applicationFramework.toLowerCase()}/src/html/`);
            logger.info("Generating App HTML in", { appSourceFolder: engineVariables.www.src });
            for (const htmlFile of htmlFiles) {
                const ret = yield this.copyFile(logger, fileSystem, scaffoldFolder, `${htmlFile}`, engineVariables.www.src, `${htmlFile}`, engineVariables.force, engineVariables.noCreateSource);
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    generateAppCss(logger, fileSystem, uniteConfiguration, engineVariables, cssFiles) {
        return __awaiter(this, void 0, void 0, function* () {
            const scaffoldFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${uniteConfiguration.applicationFramework.toLowerCase()}/src/css/${uniteConfiguration.cssPre.toLowerCase()}/`);
            logger.info("Generating App CSS in", { appSourceFolder: engineVariables.www.src });
            for (const cssFile of cssFiles) {
                const ret = yield this.copyFile(logger, fileSystem, scaffoldFolder, `${cssFile}.${uniteConfiguration.styleExtension}`, engineVariables.www.src, `${cssFile}.${uniteConfiguration.styleExtension}`, engineVariables.force, engineVariables.noCreateSource);
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    generateUnitTest(logger, fileSystem, uniteConfiguration, engineVariables, specs, isShared) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            if (!_super("condition").call(this, uniteConfiguration.unitTestRunner, "None")) {
                logger.info("Generating unit test scaffold shared", { unitTestSrcFolder: engineVariables.www.unit });
                const appFramework = isShared ? "shared" : uniteConfiguration.applicationFramework.toLowerCase();
                const unitTestsScaffold = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${appFramework}/test/unit/src/sourceLanguage/${uniteConfiguration.sourceLanguage.toLowerCase()}/` +
                    `${uniteConfiguration.unitTestFramework.toLowerCase()}/`);
                const unitTestsRunner = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/shared/test/unit/unitTestRunner/${uniteConfiguration.unitTestRunner.toLowerCase()}/`);
                for (const spec of specs) {
                    const ret = yield this.copyFile(logger, fileSystem, unitTestsScaffold, `${spec}`, engineVariables.www.unit, `${spec}`, engineVariables.force, engineVariables.noCreateSource, templateHelper_1.TemplateHelper.createCodeSubstitutions(engineVariables));
                    if (ret !== 0) {
                        return ret;
                    }
                }
                return this.copyFile(logger, fileSystem, unitTestsRunner, "unit-bootstrap.js", engineVariables.www.unitRoot, "unit-bootstrap.js", engineVariables.force, engineVariables.noCreateSource);
            }
            else {
                return 0;
            }
        });
    }
    generateE2eTest(logger, fileSystem, uniteConfiguration, engineVariables, specs, isShared) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            if (!_super("condition").call(this, uniteConfiguration.e2eTestRunner, "None")) {
                logger.info("Generating e2e test scaffold shared", { unitTestSrcFolder: engineVariables.www.e2e });
                const appFramework = isShared ? "shared" : uniteConfiguration.applicationFramework.toLowerCase();
                const e2eTestsScaffold = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${appFramework}/test/e2e/src/` +
                    `${uniteConfiguration.e2eTestRunner.toLowerCase()}/` +
                    `${uniteConfiguration.e2eTestFramework.toLowerCase()}/`);
                for (const spec of specs) {
                    const ret = yield this.copyFile(logger, fileSystem, e2eTestsScaffold, `${spec}`, engineVariables.www.e2e, `${spec}`, engineVariables.force, engineVariables.noCreateSource);
                    if (ret !== 0) {
                        return ret;
                    }
                }
                return 0;
            }
            else {
                return 0;
            }
        });
    }
    generateCss(logger, fileSystem, uniteConfiguration, engineVariables) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            logger.info("Generating application css scaffold shared", { cssSrcFolder: engineVariables.www.css });
            const assetCssFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/shared/css/${uniteConfiguration.cssPre.toLowerCase()}`);
            const styles = ["app", "main", "reset"];
            for (const style of styles) {
                const ret = yield _super("copyFile").call(this, logger, fileSystem, assetCssFolder, `${style}.${uniteConfiguration.styleExtension}`, engineVariables.www.css, `${style}.${uniteConfiguration.styleExtension}`, engineVariables.force, engineVariables.noCreateSource);
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    createLoaderReplacement(engineVariables, extension, loader, includeRequires) {
        if (includeRequires) {
            engineVariables.buildTranspileInclude.push("const replace = require(\"gulp-replace\");");
        }
        engineVariables.buildTranspilePreBuild.push(`        .pipe(replace(/import(.*?)("|'|\`)(.*?).${extension}\\2/g, "import$1$2${loader}!$3.${extension}$2"))`);
    }
    createLoaderTypeMapReplacement(engineVariables, extension, loader) {
        engineVariables.buildTranspileInclude.push("const replace = require(\"gulp-replace\");");
        engineVariables.buildTranspileInclude.push("const clientPackages = require(\"./util/client-packages\");");
        const typeMapLoader = `\${clientPackages.getTypeMap(uniteConfig, "${loader}", buildConfiguration.minify)}`;
        engineVariables.buildTranspilePreBuild.push(`        .pipe(replace(/import(.*?)("|'|\`)(.*?).${extension}\\2/g, \`import$1$2${typeMapLoader}!$3.${extension}$2\`))`);
    }
    insertRoutes(logger, fileSystem, uniteConfiguration, engineVariables, routes, routerFile, routerRegEx, sourceImports, sourceRouterItems) {
        return __awaiter(this, void 0, void 0, function* () {
            let importTexts = sourceImports;
            let routerItems = sourceRouterItems;
            const keys = Object.keys(routes);
            let doneImportInsert = false;
            let doneRouterInsert = false;
            const routerFileExists = yield fileSystem.fileExists(engineVariables.www.src, routerFile);
            if (routerFileExists) {
                const importRegEx = /(import.*;)/g;
                let routerContent = yield fileSystem.fileReadText(engineVariables.www.src, routerFile);
                importTexts = importTexts.filter(imp => routerContent.indexOf(imp) < 0);
                routerItems = routerItems.filter(ritem => routerContent.indexOf(ritem) < 0);
                if (importTexts.length === 0) {
                    doneImportInsert = true;
                }
                else {
                    const importResults = importRegEx.exec(routerContent);
                    if (importResults && importResults.length > 0) {
                        routerContent = routerContent.replace(importResults[importResults.length - 1], `${importResults[importResults.length - 1]}\n${importTexts.join("\n")}`);
                        doneImportInsert = true;
                    }
                }
                if (routerItems.length === 0) {
                    doneRouterInsert = true;
                }
                else {
                    const routerResults = routerRegEx.exec(routerContent);
                    if (routerResults && routerResults.length > 4) {
                        const routerIndent = routerResults[1];
                        const routerVar = routerResults[2];
                        const routerNewline = routerResults[3];
                        const currentRouters = routerResults[4].trim();
                        const routerEnd = routerResults[5];
                        let replaceRouters = `${routerNewline}${currentRouters},${routerNewline}`;
                        replaceRouters += `${routerItems.map(ri => ri.replace(/\n/g, routerNewline)).join(`,${routerNewline}`)}\n`;
                        routerContent = routerContent.replace(routerResults[0], `${routerIndent}${routerVar}${replaceRouters}${routerIndent}${routerEnd}`);
                        doneRouterInsert = true;
                    }
                }
                yield fileSystem.fileWriteText(engineVariables.www.src, routerFile, routerContent);
            }
            if (!doneImportInsert || !doneRouterInsert) {
                logger.banner("");
                logger.banner("==========================================");
                logger.warning("We couldn't find a location to insert the imports or routes into your router, please insert the following manually:");
                if (!doneImportInsert) {
                    logger.banner("");
                    importTexts.forEach(imp => logger.banner(`   ${imp}`));
                }
                if (!doneRouterInsert) {
                    logger.banner("");
                    routerItems.forEach(ri => logger.banner(`   ${ri}`));
                }
                logger.banner("==========================================");
                logger.banner("");
            }
            logger.banner("Once you have built the application you should be able access the new pages at the following routes:");
            logger.banner("");
            keys.forEach(key => logger.banner(`   /#/${key}`));
            logger.banner("");
            return 0;
        });
    }
}
exports.SharedAppFramework = SharedAppFramework;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9waXBlbGluZVN0ZXBzL3NoYXJlZEFwcEZyYW1ld29yay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBUUEsaUVBQThEO0FBQzlELDhEQUEyRDtBQUUzRCx3QkFBeUMsU0FBUSxtQ0FBZ0I7SUFDN0MsaUJBQWlCLENBQUMsTUFBZSxFQUNmLFVBQXVCLEVBQ3ZCLGtCQUFzQyxFQUN0QyxlQUFnQyxFQUNoQyxLQUFlLEVBQ2YsUUFBaUI7O1lBQy9DLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUVqRyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLFlBQVksUUFBUSxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRXJJLE1BQU0sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxlQUFlLEVBQUUsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBRXRGLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUNsQixjQUFjLEVBQ2QsSUFBSSxFQUNKLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUN2QixJQUFJLEVBQ0osZUFBZSxDQUFDLEtBQUssRUFDckIsZUFBZSxDQUFDLGNBQWMsRUFDOUIsK0JBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO2dCQUV6RixFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDWixNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUNmLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNiLENBQUM7S0FBQTtJQUVlLGVBQWUsQ0FBQyxNQUFlLEVBQ2YsVUFBdUIsRUFDdkIsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLFNBQW1COztZQUMvQyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUVqSSxNQUFNLENBQUMsSUFBSSxDQUFDLHdCQUF3QixFQUFFLEVBQUUsZUFBZSxFQUFFLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUVwRixHQUFHLENBQUMsQ0FBQyxNQUFNLFFBQVEsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFDbEIsY0FBYyxFQUNkLEdBQUcsUUFBUSxFQUFFLEVBQ2IsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQ3ZCLEdBQUcsUUFBUSxFQUFFLEVBQ2IsZUFBZSxDQUFDLEtBQUssRUFDckIsZUFBZSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUNoRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDWixNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUNmLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNiLENBQUM7S0FBQTtJQUVlLGNBQWMsQ0FBQyxNQUFlLEVBQ2YsVUFBdUIsRUFDdkIsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLFFBQWtCOztZQUM3QyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxZQUFZLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDM0ssTUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLGVBQWUsRUFBRSxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFFbkYsR0FBRyxDQUFDLENBQUMsTUFBTSxPQUFPLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDN0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQ2xCLGNBQWMsRUFDZCxHQUFHLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxjQUFjLEVBQUUsRUFDakQsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQ3ZCLEdBQUcsT0FBTyxJQUFJLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxFQUNqRCxlQUFlLENBQUMsS0FBSyxFQUNyQixlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBRWhFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNaLE1BQU0sQ0FBQyxHQUFHLENBQUM7Z0JBQ2YsQ0FBQztZQUNMLENBQUM7WUFFRCxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2IsQ0FBQztLQUFBO0lBRWUsZ0JBQWdCLENBQUMsTUFBZSxFQUNmLFVBQXVCLEVBQ3ZCLGtCQUFzQyxFQUN0QyxlQUFnQyxFQUNoQyxLQUFlLEVBQ2YsUUFBaUI7OztZQUM5QyxFQUFFLENBQUMsQ0FBQyxDQUFDLG1CQUFlLFlBQUMsa0JBQWtCLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUQsTUFBTSxDQUFDLElBQUksQ0FBQyxzQ0FBc0MsRUFBRSxFQUFFLGlCQUFpQixFQUFFLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFFckcsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUVqRyxNQUFNLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLGtCQUFrQixFQUNsQyxnQkFBZ0IsWUFBWSxpQ0FBaUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxHQUFHO29CQUM1RyxHQUFHLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFFOUcsTUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsa0JBQWtCLEVBQ2xDLGdEQUFnRCxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUVuSixHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO29CQUN2QixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFDckMsR0FBRyxJQUFJLEVBQUUsRUFDVCxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksRUFDeEIsR0FBRyxJQUFJLEVBQUUsRUFDVCxlQUFlLENBQUMsS0FBSyxFQUNyQixlQUFlLENBQUMsY0FBYyxFQUM5QiwrQkFBYyxDQUFDLHVCQUF1QixDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQ3pGLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNaLE1BQU0sQ0FBQyxHQUFHLENBQUM7b0JBQ2YsQ0FBQztnQkFDTCxDQUFDO2dCQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUNuQyxtQkFBbUIsRUFDbkIsZUFBZSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQzVCLG1CQUFtQixFQUNuQixlQUFlLENBQUMsS0FBSyxFQUNyQixlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFekQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDYixDQUFDO1FBQ0wsQ0FBQztLQUFBO0lBRWUsZUFBZSxDQUFDLE1BQWUsRUFDZixVQUF1QixFQUN2QixrQkFBc0MsRUFDdEMsZUFBZ0MsRUFDaEMsS0FBZSxFQUNmLFFBQWlCOzs7WUFDN0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxtQkFBZSxZQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdELE1BQU0sQ0FBQyxJQUFJLENBQUMscUNBQXFDLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBRW5HLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFFakcsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLFlBQVksZ0JBQWdCO29CQUM1QyxHQUFHLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsR0FBRztvQkFDcEQsR0FBRyxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRXpHLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBQ3ZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUNwQyxHQUFHLElBQUksRUFBRSxFQUNULGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUN2QixHQUFHLElBQUksRUFBRSxFQUNULGVBQWUsQ0FBQyxLQUFLLEVBQ3JCLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFFaEUsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ1osTUFBTSxDQUFDLEdBQUcsQ0FBQztvQkFDZixDQUFDO2dCQUNMLENBQUM7Z0JBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNiLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2IsQ0FBQztRQUNMLENBQUM7S0FBQTtJQUVlLFdBQVcsQ0FBQyxNQUFlLEVBQUUsVUFBdUIsRUFBRSxrQkFBc0MsRUFBRSxlQUFnQzs7O1lBQzFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsNENBQTRDLEVBQUUsRUFBRSxZQUFZLEVBQUUsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBRXJHLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLGtCQUFrQixFQUFFLDJCQUEyQixrQkFBa0IsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRXhKLE1BQU0sTUFBTSxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUV4QyxHQUFHLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixNQUFNLEdBQUcsR0FBRyxNQUFNLGtCQUFjLFlBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQ2xDLEdBQUcsS0FBSyxJQUFJLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxJQUFJLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxFQUN6SCxlQUFlLENBQUMsS0FBSyxFQUNyQixlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBRWpFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNaLE1BQU0sQ0FBQyxHQUFHLENBQUM7Z0JBQ2YsQ0FBQztZQUNMLENBQUM7WUFFRCxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2IsQ0FBQztLQUFBO0lBRVMsdUJBQXVCLENBQUMsZUFBZ0MsRUFBRSxTQUFpQixFQUFFLE1BQWMsRUFBRSxlQUF3QjtRQUMzSCxFQUFFLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUM3RixDQUFDO1FBQ0QsZUFBZSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxtREFBbUQsU0FBUyxxQkFBcUIsTUFBTSxPQUFPLFNBQVMsT0FBTyxDQUFDLENBQUM7SUFDaEssQ0FBQztJQUVTLDhCQUE4QixDQUFDLGVBQWdDLEVBQUUsU0FBaUIsRUFBRSxNQUFjO1FBQ3hHLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUN6RixlQUFlLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLDZEQUE2RCxDQUFDLENBQUM7UUFFMUcsTUFBTSxhQUFhLEdBQUcsOENBQThDLE1BQU0sZ0NBQWdDLENBQUM7UUFDM0csZUFBZSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxtREFBbUQsU0FBUyxzQkFBc0IsYUFBYSxPQUFPLFNBQVMsUUFBUSxDQUFDLENBQUM7SUFDekssQ0FBQztJQUVlLFlBQVksQ0FBQyxNQUFlLEVBQ2YsVUFBdUIsRUFDdkIsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLE1BQXdELEVBQ3hELFVBQWtCLEVBQ2xCLFdBQW1CLEVBQ25CLGFBQXVCLEVBQ3ZCLGlCQUEyQjs7WUFDcEQsSUFBSSxXQUFXLEdBQUcsYUFBYSxDQUFDO1lBQ2hDLElBQUksV0FBVyxHQUFHLGlCQUFpQixDQUFDO1lBRXBDLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFakMsSUFBSSxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7WUFDN0IsSUFBSSxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7WUFDN0IsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLFVBQVUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDMUYsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO2dCQUNuQixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUM7Z0JBRW5DLElBQUksYUFBYSxHQUFHLE1BQU0sVUFBVSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsQ0FBQztnQkFFdkYsV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN4RSxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBRTVFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDM0IsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO2dCQUM1QixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQ3RELEVBQUUsQ0FBQyxDQUFDLGFBQWEsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzVDLGFBQWEsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEtBQUssV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7d0JBQ3hKLGdCQUFnQixHQUFHLElBQUksQ0FBQztvQkFDNUIsQ0FBQztnQkFDTCxDQUFDO2dCQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDM0IsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO2dCQUM1QixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQ3RELEVBQUUsQ0FBQyxDQUFDLGFBQWEsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzVDLE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDdEMsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNuQyxNQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3ZDLE1BQU0sY0FBYyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQzt3QkFDL0MsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNuQyxJQUFJLGNBQWMsR0FBRyxHQUFHLGFBQWEsR0FBRyxjQUFjLElBQUksYUFBYSxFQUFFLENBQUM7d0JBQzFFLGNBQWMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQzt3QkFDM0csYUFBYSxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsWUFBWSxHQUFHLFNBQVMsR0FBRyxjQUFjLEdBQUcsWUFBWSxHQUFHLFNBQVMsRUFBRSxDQUFDLENBQUM7d0JBQ25JLGdCQUFnQixHQUFHLElBQUksQ0FBQztvQkFDNUIsQ0FBQztnQkFDTCxDQUFDO2dCQUVELE1BQU0sVUFBVSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDdkYsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2xCLE1BQU0sQ0FBQyxNQUFNLENBQUMsNENBQTRDLENBQUMsQ0FBQztnQkFDNUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxxSEFBcUgsQ0FBQyxDQUFDO2dCQUN0SSxFQUFFLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztvQkFDcEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDbEIsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzNELENBQUM7Z0JBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQ2xCLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN6RCxDQUFDO2dCQUNELE1BQU0sQ0FBQyxNQUFNLENBQUMsNENBQTRDLENBQUMsQ0FBQztnQkFDNUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0QixDQUFDO1lBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxzR0FBc0csQ0FBQyxDQUFDO1lBQ3RILE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUVsQixNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2IsQ0FBQztLQUFBO0NBQ0o7QUFwUkQsZ0RBb1JDIiwiZmlsZSI6InBpcGVsaW5lU3RlcHMvc2hhcmVkQXBwRnJhbWV3b3JrLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQaXBlbGluZSBzdGVwIHRvIGdlbmVyYXRlIHNjYWZmb2xkaW5nIGZvciBzaGFyZWQgYXBwbGljYXRpb24uXG4gKi9cbmltcG9ydCB7IElGaWxlU3lzdGVtIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JRmlsZVN5c3RlbVwiO1xuaW1wb3J0IHsgSUxvZ2dlciB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2ludGVyZmFjZXMvSUxvZ2dlclwiO1xuaW1wb3J0IHsgVW5pdGVDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3VuaXRlL3VuaXRlQ29uZmlndXJhdGlvblwiO1xuaW1wb3J0IHsgVW5pdGVQYWNrYWdlUm91dGVDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3VuaXRlUGFja2FnZXMvdW5pdGVQYWNrYWdlUm91dGVDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBFbmdpbmVWYXJpYWJsZXMgfSBmcm9tIFwiLi4vZW5naW5lL2VuZ2luZVZhcmlhYmxlc1wiO1xuaW1wb3J0IHsgUGlwZWxpbmVTdGVwQmFzZSB9IGZyb20gXCIuLi9lbmdpbmUvcGlwZWxpbmVTdGVwQmFzZVwiO1xuaW1wb3J0IHsgVGVtcGxhdGVIZWxwZXIgfSBmcm9tIFwiLi4vaGVscGVycy90ZW1wbGF0ZUhlbHBlclwiO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2hhcmVkQXBwRnJhbWV3b3JrIGV4dGVuZHMgUGlwZWxpbmVTdGVwQmFzZSB7XG4gICAgcHJvdGVjdGVkIGFzeW5jIGdlbmVyYXRlQXBwU291cmNlKGxvZ2dlcjogSUxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRlQ29uZmlndXJhdGlvbjogVW5pdGVDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXM6IEVuZ2luZVZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1NoYXJlZDogYm9vbGVhbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IGFwcEZyYW1ld29yayA9IGlzU2hhcmVkID8gXCJzaGFyZWRcIiA6IHVuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29yay50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGNvbnN0IHNjYWZmb2xkRm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMuZW5naW5lQXNzZXRzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke2FwcEZyYW1ld29ya30vc3JjLyR7dW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUxhbmd1YWdlLnRvTG93ZXJDYXNlKCl9YCk7XG5cbiAgICAgICAgbG9nZ2VyLmluZm8oXCJHZW5lcmF0aW5nIEFwcCBTb3VyY2UgaW5cIiwgeyBhcHBTb3VyY2VGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgY29uc3QgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZShsb2dnZXIsIGZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWZmb2xkRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMud3d3LnNyYyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRlbXBsYXRlSGVscGVyLmNyZWF0ZUNvZGVTdWJzdGl0dXRpb25zKGVuZ2luZVZhcmlhYmxlcykpO1xuXG4gICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUFwcEh0bWwobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbEZpbGVzOiBzdHJpbmdbXSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IHNjYWZmb2xkRm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMuZW5naW5lQXNzZXRzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29yay50b0xvd2VyQ2FzZSgpfS9zcmMvaHRtbC9gKTtcblxuICAgICAgICBsb2dnZXIuaW5mbyhcIkdlbmVyYXRpbmcgQXBwIEhUTUwgaW5cIiwgeyBhcHBTb3VyY2VGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgaHRtbEZpbGUgb2YgaHRtbEZpbGVzKSB7XG4gICAgICAgICAgICBjb25zdCByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlKGxvZ2dlciwgZmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhZmZvbGRGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke2h0bWxGaWxlfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtodG1sRmlsZX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy5ub0NyZWF0ZVNvdXJjZSk7XG4gICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUFwcENzcyhsb2dnZXI6IElMb2dnZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW06IElGaWxlU3lzdGVtLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc0ZpbGVzOiBzdHJpbmdbXSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IHNjYWZmb2xkRm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMuZW5naW5lQXNzZXRzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29yay50b0xvd2VyQ2FzZSgpfS9zcmMvY3NzLyR7dW5pdGVDb25maWd1cmF0aW9uLmNzc1ByZS50b0xvd2VyQ2FzZSgpfS9gKTtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJHZW5lcmF0aW5nIEFwcCBDU1MgaW5cIiwgeyBhcHBTb3VyY2VGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgY3NzRmlsZSBvZiBjc3NGaWxlcykge1xuICAgICAgICAgICAgY29uc3QgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZShsb2dnZXIsIGZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWZmb2xkRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtjc3NGaWxlfS4ke3VuaXRlQ29uZmlndXJhdGlvbi5zdHlsZUV4dGVuc2lvbn1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMud3d3LnNyYyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7Y3NzRmlsZX0uJHt1bml0ZUNvbmZpZ3VyYXRpb24uc3R5bGVFeHRlbnNpb259YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UpO1xuXG4gICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZVVuaXRUZXN0KGxvZ2dlcjogSUxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXM6IEVuZ2luZVZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjczogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNTaGFyZWQ6IGJvb2xlYW4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBpZiAoIXN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RSdW5uZXIsIFwiTm9uZVwiKSkge1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJHZW5lcmF0aW5nIHVuaXQgdGVzdCBzY2FmZm9sZCBzaGFyZWRcIiwgeyB1bml0VGVzdFNyY0ZvbGRlcjogZW5naW5lVmFyaWFibGVzLnd3dy51bml0IH0pO1xuXG4gICAgICAgICAgICBjb25zdCBhcHBGcmFtZXdvcmsgPSBpc1NoYXJlZCA/IFwic2hhcmVkXCIgOiB1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmsudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgY29uc3QgdW5pdFRlc3RzU2NhZmZvbGQgPSBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKGVuZ2luZVZhcmlhYmxlcy5lbmdpbmVBc3NldHNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke2FwcEZyYW1ld29ya30vdGVzdC91bml0L3NyYy9zb3VyY2VMYW5ndWFnZS8ke3VuaXRlQ29uZmlndXJhdGlvbi5zb3VyY2VMYW5ndWFnZS50b0xvd2VyQ2FzZSgpfS9gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHt1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX0vYCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHVuaXRUZXN0c1J1bm5lciA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZW5naW5lVmFyaWFibGVzLmVuZ2luZUFzc2V0c0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay9zaGFyZWQvdGVzdC91bml0L3VuaXRUZXN0UnVubmVyLyR7dW5pdGVDb25maWd1cmF0aW9uLnVuaXRUZXN0UnVubmVyLnRvTG93ZXJDYXNlKCl9L2ApO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNwZWMgb2Ygc3BlY3MpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlKGxvZ2dlciwgZmlsZVN5c3RlbSwgdW5pdFRlc3RzU2NhZmZvbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzcGVjfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMud3d3LnVuaXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzcGVjfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUZW1wbGF0ZUhlbHBlci5jcmVhdGVDb2RlU3Vic3RpdHV0aW9ucyhlbmdpbmVWYXJpYWJsZXMpKTtcbiAgICAgICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb3B5RmlsZShsb2dnZXIsIGZpbGVTeXN0ZW0sIHVuaXRUZXN0c1J1bm5lcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidW5pdC1ib290c3RyYXAuanNcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy53d3cudW5pdFJvb3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInVuaXQtYm9vdHN0cmFwLmpzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUUyZVRlc3QobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY3M6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNTaGFyZWQ6IGJvb2xlYW4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBpZiAoIXN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24uZTJlVGVzdFJ1bm5lciwgXCJOb25lXCIpKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcIkdlbmVyYXRpbmcgZTJlIHRlc3Qgc2NhZmZvbGQgc2hhcmVkXCIsIHsgdW5pdFRlc3RTcmNGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuZTJlIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBhcHBGcmFtZXdvcmsgPSBpc1NoYXJlZCA/IFwic2hhcmVkXCIgOiB1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmsudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgY29uc3QgZTJlVGVzdHNTY2FmZm9sZCA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZW5naW5lVmFyaWFibGVzLmVuZ2luZUFzc2V0c0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhcHBGcmFtZXdvcmsvJHthcHBGcmFtZXdvcmt9L3Rlc3QvZTJlL3NyYy9gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3VuaXRlQ29uZmlndXJhdGlvbi5lMmVUZXN0UnVubmVyLnRvTG93ZXJDYXNlKCl9L2AgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7dW5pdGVDb25maWd1cmF0aW9uLmUyZVRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX0vYCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3Qgc3BlYyBvZiBzcGVjcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJldCA9IGF3YWl0IHRoaXMuY29weUZpbGUobG9nZ2VyLCBmaWxlU3lzdGVtLCBlMmVUZXN0c1NjYWZmb2xkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7c3BlY31gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLnd3dy5lMmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzcGVjfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJldCAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUNzcyhsb2dnZXI6IElMb2dnZXIsIGZpbGVTeXN0ZW06IElGaWxlU3lzdGVtLCB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBsb2dnZXIuaW5mbyhcIkdlbmVyYXRpbmcgYXBwbGljYXRpb24gY3NzIHNjYWZmb2xkIHNoYXJlZFwiLCB7IGNzc1NyY0ZvbGRlcjogZW5naW5lVmFyaWFibGVzLnd3dy5jc3MgfSk7XG5cbiAgICAgICAgY29uc3QgYXNzZXRDc3NGb2xkZXIgPSBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKGVuZ2luZVZhcmlhYmxlcy5lbmdpbmVBc3NldHNGb2xkZXIsIGBhcHBGcmFtZXdvcmsvc2hhcmVkL2Nzcy8ke3VuaXRlQ29uZmlndXJhdGlvbi5jc3NQcmUudG9Mb3dlckNhc2UoKX1gKTtcblxuICAgICAgICBjb25zdCBzdHlsZXMgPSBbXCJhcHBcIiwgXCJtYWluXCIsIFwicmVzZXRcIl07XG5cbiAgICAgICAgZm9yIChjb25zdCBzdHlsZSBvZiBzdHlsZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJldCA9IGF3YWl0IHN1cGVyLmNvcHlGaWxlKGxvZ2dlciwgZmlsZVN5c3RlbSwgYXNzZXRDc3NGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzdHlsZX0uJHt1bml0ZUNvbmZpZ3VyYXRpb24uc3R5bGVFeHRlbnNpb259YCwgZW5naW5lVmFyaWFibGVzLnd3dy5jc3MsIGAke3N0eWxlfS4ke3VuaXRlQ29uZmlndXJhdGlvbi5zdHlsZUV4dGVuc2lvbn1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLm5vQ3JlYXRlU291cmNlKTtcblxuICAgICAgICAgICAgaWYgKHJldCAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlTG9hZGVyUmVwbGFjZW1lbnQoZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsIGV4dGVuc2lvbjogc3RyaW5nLCBsb2FkZXI6IHN0cmluZywgaW5jbHVkZVJlcXVpcmVzOiBib29sZWFuKSA6IHZvaWQge1xuICAgICAgICBpZiAoaW5jbHVkZVJlcXVpcmVzKSB7XG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVJbmNsdWRlLnB1c2goXCJjb25zdCByZXBsYWNlID0gcmVxdWlyZShcXFwiZ3VscC1yZXBsYWNlXFxcIik7XCIpO1xuICAgICAgICB9XG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goYCAgICAgICAgLnBpcGUocmVwbGFjZSgvaW1wb3J0KC4qPykoXCJ8J3xcXGApKC4qPykuJHtleHRlbnNpb259XFxcXDIvZywgXCJpbXBvcnQkMSQyJHtsb2FkZXJ9ISQzLiR7ZXh0ZW5zaW9ufSQyXCIpKWApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVMb2FkZXJUeXBlTWFwUmVwbGFjZW1lbnQoZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsIGV4dGVuc2lvbjogc3RyaW5nLCBsb2FkZXI6IHN0cmluZykgOiB2b2lkIHtcbiAgICAgICAgZW5naW5lVmFyaWFibGVzLmJ1aWxkVHJhbnNwaWxlSW5jbHVkZS5wdXNoKFwiY29uc3QgcmVwbGFjZSA9IHJlcXVpcmUoXFxcImd1bHAtcmVwbGFjZVxcXCIpO1wiKTtcbiAgICAgICAgZW5naW5lVmFyaWFibGVzLmJ1aWxkVHJhbnNwaWxlSW5jbHVkZS5wdXNoKFwiY29uc3QgY2xpZW50UGFja2FnZXMgPSByZXF1aXJlKFxcXCIuL3V0aWwvY2xpZW50LXBhY2thZ2VzXFxcIik7XCIpO1xuXG4gICAgICAgIGNvbnN0IHR5cGVNYXBMb2FkZXIgPSBgXFwke2NsaWVudFBhY2thZ2VzLmdldFR5cGVNYXAodW5pdGVDb25maWcsIFwiJHtsb2FkZXJ9XCIsIGJ1aWxkQ29uZmlndXJhdGlvbi5taW5pZnkpfWA7XG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goYCAgICAgICAgLnBpcGUocmVwbGFjZSgvaW1wb3J0KC4qPykoXCJ8J3xcXGApKC4qPykuJHtleHRlbnNpb259XFxcXDIvZywgXFxgaW1wb3J0JDEkMiR7dHlwZU1hcExvYWRlcn0hJDMuJHtleHRlbnNpb259JDJcXGApKWApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBpbnNlcnRSb3V0ZXMobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGVzOiB7IFtpZDogc3RyaW5nXTogVW5pdGVQYWNrYWdlUm91dGVDb25maWd1cmF0aW9uIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0ZXJGaWxlOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0ZXJSZWdFeDogUmVnRXhwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlSW1wb3J0czogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VSb3V0ZXJJdGVtczogc3RyaW5nW10pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBsZXQgaW1wb3J0VGV4dHMgPSBzb3VyY2VJbXBvcnRzO1xuICAgICAgICBsZXQgcm91dGVySXRlbXMgPSBzb3VyY2VSb3V0ZXJJdGVtcztcblxuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocm91dGVzKTtcblxuICAgICAgICBsZXQgZG9uZUltcG9ydEluc2VydCA9IGZhbHNlO1xuICAgICAgICBsZXQgZG9uZVJvdXRlckluc2VydCA9IGZhbHNlO1xuICAgICAgICBjb25zdCByb3V0ZXJGaWxlRXhpc3RzID0gYXdhaXQgZmlsZVN5c3RlbS5maWxlRXhpc3RzKGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjLCByb3V0ZXJGaWxlKTtcbiAgICAgICAgaWYgKHJvdXRlckZpbGVFeGlzdHMpIHtcbiAgICAgICAgICAgIGNvbnN0IGltcG9ydFJlZ0V4ID0gLyhpbXBvcnQuKjspL2c7XG5cbiAgICAgICAgICAgIGxldCByb3V0ZXJDb250ZW50ID0gYXdhaXQgZmlsZVN5c3RlbS5maWxlUmVhZFRleHQoZW5naW5lVmFyaWFibGVzLnd3dy5zcmMsIHJvdXRlckZpbGUpO1xuXG4gICAgICAgICAgICBpbXBvcnRUZXh0cyA9IGltcG9ydFRleHRzLmZpbHRlcihpbXAgPT4gcm91dGVyQ29udGVudC5pbmRleE9mKGltcCkgPCAwKTtcbiAgICAgICAgICAgIHJvdXRlckl0ZW1zID0gcm91dGVySXRlbXMuZmlsdGVyKHJpdGVtID0+IHJvdXRlckNvbnRlbnQuaW5kZXhPZihyaXRlbSkgPCAwKTtcblxuICAgICAgICAgICAgaWYgKGltcG9ydFRleHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGRvbmVJbXBvcnRJbnNlcnQgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbXBvcnRSZXN1bHRzID0gaW1wb3J0UmVnRXguZXhlYyhyb3V0ZXJDb250ZW50KTtcbiAgICAgICAgICAgICAgICBpZiAoaW1wb3J0UmVzdWx0cyAmJiBpbXBvcnRSZXN1bHRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcm91dGVyQ29udGVudCA9IHJvdXRlckNvbnRlbnQucmVwbGFjZShpbXBvcnRSZXN1bHRzW2ltcG9ydFJlc3VsdHMubGVuZ3RoIC0gMV0sIGAke2ltcG9ydFJlc3VsdHNbaW1wb3J0UmVzdWx0cy5sZW5ndGggLSAxXX1cXG4ke2ltcG9ydFRleHRzLmpvaW4oXCJcXG5cIil9YCk7XG4gICAgICAgICAgICAgICAgICAgIGRvbmVJbXBvcnRJbnNlcnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJvdXRlckl0ZW1zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGRvbmVSb3V0ZXJJbnNlcnQgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCByb3V0ZXJSZXN1bHRzID0gcm91dGVyUmVnRXguZXhlYyhyb3V0ZXJDb250ZW50KTtcbiAgICAgICAgICAgICAgICBpZiAocm91dGVyUmVzdWx0cyAmJiByb3V0ZXJSZXN1bHRzLmxlbmd0aCA+IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm91dGVySW5kZW50ID0gcm91dGVyUmVzdWx0c1sxXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm91dGVyVmFyID0gcm91dGVyUmVzdWx0c1syXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm91dGVyTmV3bGluZSA9IHJvdXRlclJlc3VsdHNbM107XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3V0ZXJzID0gcm91dGVyUmVzdWx0c1s0XS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvdXRlckVuZCA9IHJvdXRlclJlc3VsdHNbNV07XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXBsYWNlUm91dGVycyA9IGAke3JvdXRlck5ld2xpbmV9JHtjdXJyZW50Um91dGVyc30sJHtyb3V0ZXJOZXdsaW5lfWA7XG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VSb3V0ZXJzICs9IGAke3JvdXRlckl0ZW1zLm1hcChyaSA9PiByaS5yZXBsYWNlKC9cXG4vZywgcm91dGVyTmV3bGluZSkpLmpvaW4oYCwke3JvdXRlck5ld2xpbmV9YCl9XFxuYDtcbiAgICAgICAgICAgICAgICAgICAgcm91dGVyQ29udGVudCA9IHJvdXRlckNvbnRlbnQucmVwbGFjZShyb3V0ZXJSZXN1bHRzWzBdLCBgJHtyb3V0ZXJJbmRlbnR9JHtyb3V0ZXJWYXJ9JHtyZXBsYWNlUm91dGVyc30ke3JvdXRlckluZGVudH0ke3JvdXRlckVuZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgZG9uZVJvdXRlckluc2VydCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCBmaWxlU3lzdGVtLmZpbGVXcml0ZVRleHQoZW5naW5lVmFyaWFibGVzLnd3dy5zcmMsIHJvdXRlckZpbGUsIHJvdXRlckNvbnRlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFkb25lSW1wb3J0SW5zZXJ0IHx8ICFkb25lUm91dGVySW5zZXJ0KSB7XG4gICAgICAgICAgICBsb2dnZXIuYmFubmVyKFwiXCIpO1xuICAgICAgICAgICAgbG9nZ2VyLmJhbm5lcihcIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVwiKTtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKFwiV2UgY291bGRuJ3QgZmluZCBhIGxvY2F0aW9uIHRvIGluc2VydCB0aGUgaW1wb3J0cyBvciByb3V0ZXMgaW50byB5b3VyIHJvdXRlciwgcGxlYXNlIGluc2VydCB0aGUgZm9sbG93aW5nIG1hbnVhbGx5OlwiKTtcbiAgICAgICAgICAgIGlmICghZG9uZUltcG9ydEluc2VydCkge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG4gICAgICAgICAgICAgICAgaW1wb3J0VGV4dHMuZm9yRWFjaChpbXAgPT4gbG9nZ2VyLmJhbm5lcihgICAgJHtpbXB9YCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFkb25lUm91dGVySW5zZXJ0KSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmJhbm5lcihcIlwiKTtcbiAgICAgICAgICAgICAgICByb3V0ZXJJdGVtcy5mb3JFYWNoKHJpID0+IGxvZ2dlci5iYW5uZXIoYCAgICR7cml9YCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbG9nZ2VyLmJhbm5lcihcIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVwiKTtcbiAgICAgICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG4gICAgICAgIH1cblxuICAgICAgICBsb2dnZXIuYmFubmVyKFwiT25jZSB5b3UgaGF2ZSBidWlsdCB0aGUgYXBwbGljYXRpb24geW91IHNob3VsZCBiZSBhYmxlIGFjY2VzcyB0aGUgbmV3IHBhZ2VzIGF0IHRoZSBmb2xsb3dpbmcgcm91dGVzOlwiKTtcbiAgICAgICAgbG9nZ2VyLmJhbm5lcihcIlwiKTtcbiAgICAgICAga2V5cy5mb3JFYWNoKGtleSA9PiBsb2dnZXIuYmFubmVyKGAgICAvIy8ke2tleX1gKSk7XG4gICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG5cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxufVxuIl19
