/**
 * Gulp tasks for building JavaScript.
 */
const display = require('./util/display');
const uc = require('./util/unite-config');
const gulp = require('gulp');
const babel = require('gulp-babel');
const path = require('path');
const sourcemaps = require('gulp-sourcemaps');

gulp.task('build-transpile', () => {
    display.info('Running', "Babel");

    const uniteConfig = uc.getUniteConfig();
    let errorCount = 0;

    return gulp.src(path.join(uniteConfig.directories.src, '**/*.js'))
        .pipe(sourcemaps.init())
        .pipe(babel())
        .on('error', (err) => {
            display.error('error: ' + err.message + '\n');
            display.error(err.codeFrame);
            errorCount++;
        })
        .pipe(sourcemaps.mapSources((sourcePath, file) => {
            return './src/' + sourcePath;
        }))
        .pipe(sourcemaps.write({ includeContent: true, sourceRoot: '' }))
        .pipe(gulp.dest(uniteConfig.directories.dist))
        .on('end', () => {
            if (errorCount > 0) {
                process.exit();
            }
        });
});

/* Generated by UniteJS */
