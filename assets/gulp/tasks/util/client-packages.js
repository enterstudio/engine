/**
 * Gulp utils for client packages.
 */
const path = require("path");

function getKeys (uniteConfig, includeModes) {
    const pathKeys = [];
    const keys = Object.keys(uniteConfig.clientPackages);

    for (let i = 0; i < keys.length; i++) {
        const pkg = uniteConfig.clientPackages[keys[i]];
        if (includeModes.indexOf(pkg.includeMode) >= 0 && !pkg.scriptInclude) {
            if (pkg.main || pkg.mainMinified) {
                pathKeys.push(keys[i]);
            }
        }
    }

    return pathKeys;
}

function getFiles (uniteConfig, includeModes, isMinified) {
    const files = {};
    const keys = Object.keys(uniteConfig.clientPackages);

    for (let i = 0; i < keys.length; i++) {
        const pkg = uniteConfig.clientPackages[keys[i]];
        if (includeModes.indexOf(pkg.includeMode) >= 0 && !pkg.scriptInclude) {
            if (pkg.main || (isMinified && pkg.mainMinified)) {
                const mainSplit = isMinified && pkg.mainMinified ? pkg.mainMinified.split("/") : pkg.main.split("/");
                const main = mainSplit.pop();
                const location = mainSplit.join("/");
                if (pkg.isPackage) {
                    files[keys[i]] = path.join(`${uniteConfig.dirs.www.package}${keys[i]}/${location}`,
                        "**/*.{js,html,css}");
                } else {
                    files[keys[i]] = path.join(`${uniteConfig.dirs.www.package}${keys[i]}/${location}`, main);
                }
            }
        }
    }

    return files;
}

function getRequires (uniteConfig, includeModes, isMinified) {
    const requires = [];
    const keys = Object.keys(uniteConfig.clientPackages);

    for (let i = 0; i < keys.length; i++) {
        const pkg = uniteConfig.clientPackages[keys[i]];
        if (includeModes.indexOf(pkg.includeMode) >= 0 && !pkg.scriptInclude) {
            const pkgMain = isMinified && pkg.mainMinified ? pkg.mainMinified : pkg.main;

            if (pkgMain && pkgMain !== "*") {
                requires.push(keys[i]);
            }
        }
    }

    return requires;
}

function getAssets (uniteConfig) {
    const assets = [];
    const keys = Object.keys(uniteConfig.clientPackages);

    for (let i = 0; i < keys.length; i++) {
        const clientAssets = uniteConfig.clientPackages[keys[i]].assets;
        if (clientAssets !== undefined && clientAssets !== null && clientAssets.length > 0) {
            const cas = clientAssets.split(",");
            cas.forEach((ca) => {
                assets.push(path.join(`${uniteConfig.dirs.www.package}${keys[i]}/`, ca));
            });
        }
    }

    return assets;
}

function buildModuleConfig (uniteConfig, includeModes, isMinified) {
    const moduleConfig = {
        "paths": {},
        "packages": [],
        "preload": []
    };

    const keys = Object.keys(uniteConfig.clientPackages);
    for (let i = 0; i < keys.length; i++) {
        const pkg = uniteConfig.clientPackages[keys[i]];
        if (includeModes.indexOf(pkg.includeMode) >= 0 && !pkg.scriptInclude) {
            const pkgMain = isMinified && pkg.mainMinified ? pkg.mainMinified : pkg.main;

            if (pkgMain) {
                if (pkgMain.indexOf("*") >= 0) {
                    moduleConfig.paths[keys[i]] = `${uniteConfig.dirs.www.package}${keys[i]}/`;
                } else {
                    const mainSplit = pkgMain.split("/");
                    const main = mainSplit.pop().replace(/(\.js)$/, "");
                    let location = mainSplit.join("/");

                    if (pkg.isPackage) {
                        moduleConfig.packages.push({
                            "name": keys[i],
                            "location": `${uniteConfig.dirs.www.package}${keys[i]}/${location}`,
                            main
                        });
                    } else {
                        location += location.length > 0 ? "/" : "";
                        moduleConfig.paths[keys[i]] = `${uniteConfig.dirs.www.package}${keys[i]}/${location}${main}`;
                    }

                    if (pkg.preload) {
                        moduleConfig.preload.push(keys[i]);
                    }
                }
            }
        }
    }

    return moduleConfig;
}

module.exports = {
    buildModuleConfig,
    getAssets,
    getFiles,
    getKeys,
    getRequires
};

/* Generated by UniteJS */
