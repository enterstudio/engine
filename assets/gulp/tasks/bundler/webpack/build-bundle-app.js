/**
 * Gulp tasks for wrapping Webpack modules.
 */
const display = require("./util/display");
const gulp = require("gulp");
const path = require("path");
const webpack = require("webpack");
const webpackStream = require("webpack-stream");
const uc = require("./util/unite-config");
const asyncUtil = require("./util/async-util");
const UglifyJSPlugin = require("uglifyjs-webpack-plugin");
const clientPackages = require("./util/client-packages");

gulp.task("build-bundle-app", async () => {
    const uniteConfig = await uc.getUniteConfig();

    const buildConfiguration = uc.getBuildConfiguration(uniteConfig);

    if (buildConfiguration.bundle) {
        display.info("Running", "Webpack for App");

        const entry = {};
        const plugins = [];

        const keys = clientPackages.getModuleIds(uniteConfig, ["app", "both"])
            .filter(key => key.toLowerCase().indexOf("systemjs") < 0);

        if (keys.length > 0) {
            entry.vendor = keys;
        }
        plugins.push(new webpack.optimize.CommonsChunkPlugin({
            "filename": "vendor-bundle.js",
            "name": "vendor"
        }));

        if (buildConfiguration.minify) {
            process.env.NODE_ENV = "production";
            plugins.push(new UglifyJSPlugin());
            plugins.push(new webpack.DefinePlugin({
                "process.env": {
                    "NODE_ENV": JSON.stringify(process.env.NODE_ENV)
                }
            }));
        }

        entry.app = `./${path.join(uniteConfig.dirs.www.dist, "entryPoint.js")}`;

        const webpackOptions = {
            entry,
            "output": {
                "devtoolModuleFilenameTemplate": "[resource-path]",
                "filename": "app-bundle.js"
            },
            plugins,
            "module": {
                "rules": [
                    {
                        "test": /\.css$/,
                        "use": ["style-loader", "css-loader"]
                    }
                ]
            }
        };

        if (buildConfiguration.sourcemaps) {
            webpackOptions.devtool = "inline-source-map";
            webpackOptions.module.rules.push({
                "test": /\.js$/,
                "enforce": "pre",
                "loader": "source-map-loader"
            });
        }

        return asyncUtil.stream(gulp.src(entry.app)
            .pipe(webpackStream(webpackOptions, webpack))
            .pipe(gulp.dest(uniteConfig.dirs.www.dist)));
    }
});

/* Generated by UniteJS */
